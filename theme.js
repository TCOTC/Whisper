!function(){"use strict";const isPublish=()=>!!window.siyuan.isPublish,isMobile=()=>!!window.siyuan.mobile,isTouchDevice=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,isWindows=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,e="light",t="dark",getThemeCurrentMode=()=>{var n,i;const s=null==(i=null==(n=window.siyuan.config)?void 0:n.appearance)?void 0:i.mode;return s?0===s?e:t:document.documentElement.getAttribute("data-theme-mode")||""},getOSThemeModeValue=()=>window.matchMedia("(prefers-color-scheme: light)").matches?0:1,getCurrentTheme=(n=getThemeCurrentMode())=>n===e?getCurrentThemeLight():n===t?getCurrentThemeDark():"",getCurrentThemeByValue=e=>0===e?getCurrentThemeLight():1===e?getCurrentThemeDark():2===e?getCurrentThemeByValue(getOSThemeModeValue()):"",getCurrentThemeLight=()=>{var e,t;const n=null==(t=null==(e=window.siyuan.config)?void 0:e.appearance)?void 0:t.themeLight;return n||(document.documentElement.getAttribute("data-light-theme")||"")},getCurrentThemeDark=()=>{var e,t;const n=null==(t=null==(e=window.siyuan.config)?void 0:e.appearance)?void 0:t.themeDark;return n||(document.documentElement.getAttribute("data-dark-theme")||"")};class DeviceDetector{init(){this.addDeviceTypeAttribute()}destroy(){document.body.removeAttribute("data-whisper-device")}addDeviceTypeAttribute(){isMobile()?document.body.dataset.whisperDevice="mobile":navigator.platform.toUpperCase().indexOf("MAC")>-1?document.body.dataset.whisperDevice="mac":isWindows()&&(document.body.dataset.whisperDevice="windows")}}class BlockFocusHandler{constructor(){this.focusBlock=async e=>{let t=null;if(document.activeElement instanceof HTMLElement&&(t=document.activeElement.closest(".protyle-wysiwyg")),!t)return;if(t.querySelector(".protyle-wysiwyg--select"))return void this.clearBlockFocusAttribute(t);let n=null;if(e.target instanceof HTMLElement){const t=e.target.closest("[data-node-id]");t instanceof HTMLElement&&(n=t)}if(!n&&e instanceof TouchEvent&&e.changedTouches&&e.changedTouches.length>0){const t=e.changedTouches[0],i=document.elementFromPoint(t.clientX,t.clientY);if(i instanceof HTMLElement){const e=i.closest("[data-node-id]");e instanceof HTMLElement&&(n=e)}}if(!n){await new Promise(e=>setTimeout(e,10));const e=window.getSelection();if(!e||!e.anchorNode)return;const t=e.anchorNode.parentElement;t instanceof HTMLElement&&(n=t.closest("[data-node-id]"))}(null==n?void 0:n.hasAttribute("data-whisper-block-focus"))||(this.clearBlockFocusAttribute(t),n&&!n.closest(".protyle-wysiwyg__embed")&&(n.dataset.whisperBlockFocus=""))}}init(){document.addEventListener("mouseup",this.focusBlock,!0),document.addEventListener("keyup",this.focusBlock,!0),document.addEventListener("dragend",this.focusBlock,!0),document.addEventListener("touchend",this.focusBlock,!0),document.addEventListener("touchcancel",this.focusBlock,!0)}destroy(){document.removeEventListener("mouseup",this.focusBlock,!0),document.removeEventListener("keyup",this.focusBlock,!0),document.removeEventListener("dragend",this.focusBlock,!0),document.removeEventListener("touchend",this.focusBlock,!0),document.removeEventListener("touchcancel",this.focusBlock,!0),this.clearBlockFocusAttribute()}clearBlockFocusAttribute(e=document){e.querySelectorAll("[data-whisper-block-focus]").forEach(e=>{e instanceof HTMLElement&&delete e.dataset.whisperBlockFocus})}}const n=new class Logger{constructor(e){this.prefix="Whisper",e&&(this.prefix=e)}log(...e){console.log(`[${this.prefix}]`,...e)}error(...e){console.error(`[${this.prefix}]`,...e)}warn(...e){console.warn(`[${this.prefix}]`,...e)}info(...e){console.info(`[${this.prefix}]`,...e)}debug(...e){console.debug(`[${this.prefix}]`,...e)}};class ElementStatusObserver{constructor(){this.retryIntervalId=null,this.elementObserver=null,this.targets=[]}init(){this.setupTargets(),this.startObserving()}destroy(){this.retryIntervalId&&(clearInterval(this.retryIntervalId),this.retryIntervalId=null),this.elementObserver&&(this.elementObserver.disconnect(),this.elementObserver=null),setTimeout(()=>{"Whisper"!==getCurrentTheme()&&this.targets.forEach(e=>{e.found&&e.checks.forEach(e=>{const t=`data-${e.datasetProp.replace(/([A-Z])/g,"-$1").toLowerCase()}`;document.documentElement.removeAttribute(t)})})},3e3)}createBaseTarget(e,t,n){return{selector:e,checks:t,found:!1,timedOut:!1,element:null,exclude:n}}setupTargets(){this.targets=[this.createBaseTarget("#status",[{datasetProp:"whisperStatus",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}]),this.createBaseTarget("#dockLeft",[{datasetProp:"whisperDockLeft",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget("#dockRight",[{datasetProp:"whisperDockRight",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget("#dockBottom",[{datasetProp:"whisperDockBottom",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget(".layout__dockl",[{datasetProp:"whisperLayoutDockl",attributeFilter:"style",check:e=>"0px"===e.style.width,stateMap:{true:"hide",false:"show"}},{datasetProp:"whisperLayoutDocklFloat",attributeFilter:"class",check:e=>e.classList.contains("layout--float"),stateMap:{true:"float",false:"pin"}}],{selector:"body.body--window"}),this.createBaseTarget(".layout__dockr",[{datasetProp:"whisperLayoutDockr",attributeFilter:"style",check:e=>"0px"===e.style.width,stateMap:{true:"hide",false:"show"}},{datasetProp:"whisperLayoutDockrFloat",attributeFilter:"class",check:e=>e.classList.contains("layout--float"),stateMap:{true:"float",false:"pin"}}],{selector:"body.body--window"})]}startObserving(){this.elementObserver=new MutationObserver(e=>{for(const t of e){const e=t.target,n=this.targets.find(t=>t.element===e);n&&n.checks.forEach(n=>{if(n.attributeFilter===t.attributeName){const t=n.check(e);document.documentElement.dataset[n.datasetProp]=n.stateMap[String(t)]}})}});let e=0;this.retryIntervalId=window.setInterval(()=>{e++;let t=!1;this.targets.forEach(i=>{if(i.found||i.timedOut)return;let s=!1;if(i.exclude){const e=document.querySelector(i.exclude.selector);e&&(s=!i.exclude.check||i.exclude.check(e))}if(s)return void(i.timedOut=!0);const o=document.querySelector(i.selector);o?(i.element=o,i.found=!0,this.setupObserver(i)):e>=50?(i.timedOut=!0,n.error(`failed to find target node: ${i.selector}`)):t=!0}),(!t||e>=50)&&this.retryIntervalId&&(clearInterval(this.retryIntervalId),this.retryIntervalId=null)},100)}setupObserver(e){if(!e.element||!this.elementObserver)return;e.checks.forEach(t=>{const n=t.check(e.element);document.documentElement.dataset[t.datasetProp]=t.stateMap[String(n)]});const t=Array.from(new Set(e.checks.map(e=>e.attributeFilter)));this.elementObserver.observe(e.element,{attributes:!0,attributeFilter:t})}}class TooltipHandler{constructor(){this.tooltipElement=null,this.updateTooltipData=async e=>{if(!e.target||9===e.target.nodeType)return;if(!this.tooltipElement)return void(await this.getTooltipElement());const t=3===e.target.nodeType?e.target.parentElement:e.target;if(t.closest('[data-type="navigation-file"]'))return void this.removeTooltipData();const n=t.getAttribute("data-href");if(n)return(e=>{if(!e)return!1;if(1>(e=e.trim()).length)return!1;if((e=e.toLowerCase()).startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\"))return!0;if(isWindows())return 1===e.indexOf(":");return e.startsWith("/")})(n)?void this.setTooltipData("href_asset"):void this.setTooltipData("href",!0);t.closest('[data-type="tab-header"]')?this.setTooltipData("tab_header",!0):t.closest(".av__cell")||t.closest('[data-type="addColOptionOrCell"]')||t.closest('[data-type="av-add"]')||t.closest('[data-type="av-add-more"]')||t.closest('[data-type="av-header-add"]')||t.closest("[data-page]")?this.setTooltipData("av"):t.classList.contains("emojis__item")||t.classList.contains("emojis__type")?this.setTooltipData("emoji"):t.closest(".protyle-attr--memo")?this.setTooltipData("block_memo"):this.tooltipElement&&!this.tooltipElement.classList.contains("fn__none")&&(this.tooltipElement.dataset.whisperTooltip="")}}async getTooltipElement(){this.tooltipElement||(this.tooltipElement=document.getElementById("tooltip"))}async init(){await this.getTooltipElement(),this.tooltipElement||n.error("tooltip element does not exist."),document.addEventListener("mouseover",this.updateTooltipData)}async destroy(){var e;document.removeEventListener("mouseover",this.updateTooltipData),await this.getTooltipElement(),null==(e=this.tooltipElement)||e.removeAttribute("data-whisper-tooltip"),this.tooltipElement=null}setTooltipData(e,t=!1){var n;if(this.tooltipElement)if((null==(n=this.tooltipElement.dataset)?void 0:n.whisperTooltip)!==e&&(this.tooltipElement.dataset.whisperTooltip=e),t){const e=this.tooltipElement.getAttribute("style")||"";this.tooltipElement.setAttribute("style",`${e} display: flex !important`)}else this.tooltipElement.style.removeProperty("display")}removeTooltipData(e){var t;this.tooltipElement&&(e&&(null==(t=this.tooltipElement.dataset)?void 0:t.whisperTooltip)!==e||(this.tooltipElement.dataset.whisperTooltip=""))}}function themeSwitch(i,s){var o,r;switch(i){case"commonMenu":{const n=null==(o=s.target.closest(".b3-menu__item"))?void 0:o.getAttribute("data-id");if(!n||!["themeLight","themeDark","themeOS"].includes(n))return;const i="themeOS"===n?window.matchMedia("(prefers-color-scheme: light)").matches?e:t:"themeLight"===n?e:t;if(i===getThemeCurrentMode()||"Whisper"!==getCurrentTheme(i))return;break}case"dialog":{const t=s.target,n=parseInt(null==(r=t.closest("#mode"))?void 0:r.value);if(isNaN(n)||![0,1,2].includes(n))return;const i=2===n?getOSThemeModeValue():n;if(i===(()=>{var t,n;const i=null==(n=null==(t=window.siyuan.config)?void 0:t.appearance)?void 0:n.mode;if(i)return i;const s=document.documentElement.getAttribute("data-theme-mode");return s?s===e?0:1:NaN})()||"Whisper"!==getCurrentThemeByValue(i))return;break}default:return}!function applyAnimation(e){if(!document.startViewTransition)return void n.error("View Transitions API is not supported");const t=document.startViewTransition(),i=e.clientX,s=e.clientY,o=Math.hypot(Math.max(i,window.innerWidth-i),Math.max(s,window.innerHeight-s)),r=document.createElement("style");r.innerHTML="::view-transition-old(root),::view-transition-new(root){animation: none;}",document.head.appendChild(r),t.ready.then(()=>{const e=document.documentElement.animate({clipPath:[`circle(0 at ${i}px ${s}px)`,`circle(${o}px at ${i}px ${s}px)`]},{duration:550,pseudoElement:"::view-transition-new(root)",easing:"ease-in-out"}),clickHandler=()=>{e.finish()};document.addEventListener("mousedown",clickHandler),e.onfinish=()=>{document.removeEventListener("mousedown",clickHandler),setTimeout(()=>{null==r||r.remove()},300)}})}(s)}class MenuHandler{constructor(){this.commonMenuObserver=null,this.commonMenu=null,this.whisperCommonMenu=null,this.handleMenuClick=e=>{var t;"barmode"===((null==(t=e.target.closest("#commonMenu"))?void 0:t.getAttribute("data-name"))||"")&&themeSwitch("commonMenu",e)},this.handleCloseClick=e=>{e.target instanceof HTMLElement&&!e.target.closest(".b3-menu__submenu")&&(e.preventDefault(),e.stopPropagation())}}init(){this.setupMenuObserver()}destroy(){this.commonMenuObserver&&(this.commonMenuObserver.disconnect(),this.commonMenuObserver=null),this.commonMenu&&(this.commonMenu.removeEventListener("click",this.handleMenuClick,!0),this.commonMenu.removeEventListener("click",this.handleCloseClick,!0),this.commonMenu=null),this.whisperCommonMenu&&(this.whisperCommonMenu.remove(),this.whisperCommonMenu=null)}setupMenuObserver(){if(this.commonMenu=document.getElementById("commonMenu"),!this.commonMenu)return void n.error("commonMenu element does not exist.");const e=document.createElement("div");e.id="whisperCommonMenu",this.commonMenu.insertAdjacentElement("beforebegin",e),this.whisperCommonMenu=e,this.commonMenuObserver=new MutationObserver(()=>{var e;if(null==(e=this.whisperCommonMenu)||e.removeAttribute("data-name"),this.commonMenu){this.commonMenu.removeEventListener("click",this.handleMenuClick,!0),this.commonMenu.removeEventListener("click",this.handleCloseClick,!0);const e=this.commonMenu.getAttribute("data-name");"barmode"===e?this.commonMenu.addEventListener("click",this.handleMenuClick,!0):("tab"===e||this.commonMenu.querySelector('[data-id="close"]')&&this.commonMenu.querySelector('[data-id="split"]')&&this.commonMenu.querySelector('[data-id="copy"]'))&&(this.whisperCommonMenu&&(this.whisperCommonMenu.dataset.name="tab-header"),this.handleTabClose())}}),this.commonMenuObserver.observe(this.commonMenu,{attributes:!0})}handleTabClose(){var e,t;if(!this.commonMenu)return;const n=this.commonMenu.querySelector('[data-id="close"]');if(!n)return;isTouchDevice()&&this.commonMenu.addEventListener("click",this.handleCloseClick,!0);const i=n.cloneNode(!0);null==(e=i.querySelector(".b3-menu__icon"))||e.remove(),null==(t=n.querySelector(".b3-menu__accelerator"))||t.remove(),n.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg><div class="b3-menu__submenu"><div class="b3-menu__items"></div></div>');const s=n.querySelector(".b3-menu__items");if(!s)return;s.appendChild(i),this.commonMenu.querySelectorAll('[data-id="closeOthers"], [data-id="closeAll"], [data-id="closeUnmodified"], [data-id="closeLeft"], [data-id="closeRight"]').forEach(e=>{var t;null==(t=e.querySelector(".b3-menu__icon"))||t.remove(),s.appendChild(e)});const o=this.commonMenu.querySelector('[data-id="split"] > .b3-menu__icon > use');o&&o.setAttribute("xlink:href","#iconSplitLR")}}class DialogHandler{constructor(){this.bodyObserver=null,this.searchAssetsObserver=null,this.searchTipElements=[],this.settingDialogObserver=null,this.modeSelect=null,this.handleModeChange=e=>{const t=e.target;if(t&&"mode"===t.id){const e=t.getBoundingClientRect(),n=e.left+e.width/2,i=e.top+e.height/2+30,s=new MouseEvent("click",{clientX:n,clientY:i,bubbles:!0,cancelable:!0});Object.defineProperty(s,"target",{value:t,enumerable:!0}),themeSwitch("dialog",s)}}}init(){document.querySelectorAll(".b3-dialog--open").forEach(e=>{this.handleDialogOpen(e)}),this.setupBodyObserver()}destroy(){var e,t,n,i;null==(e=this.bodyObserver)||e.disconnect(),this.bodyObserver=null,null==(t=this.settingDialogObserver)||t.disconnect(),this.settingDialogObserver=null,null==(n=this.modeSelect)||n.removeEventListener("change",this.handleModeChange),this.modeSelect=null,null==(i=this.searchAssetsObserver)||i.disconnect(),this.searchAssetsObserver=null,this.searchTipElements.forEach(e=>{e.classList.remove("resize__move")}),this.searchTipElements=[]}setupBodyObserver(){this.bodyObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&setTimeout(()=>{const t=e;t.hasAttribute("data-key")&&this.handleDialogOpen(t)})})})}),this.bodyObserver.observe(document.body,{childList:!0})}handleDialogOpen(e){switch(e.dataset.key){case"dialog-setting":this.setupThemeChangeListener(e);break;case"dialog-globalsearch":case"dialog-search":this.handleSearchDialog(e);break;default:return}}setupThemeChangeListener(e){const t=e.querySelector("#mode");t?this.attachModeChangeListener(t):(this.settingDialogObserver=new MutationObserver(e=>{var t,n;for(const i of e)for(const e of i.addedNodes){if(e.nodeType!==Node.ELEMENT_NODE)continue;const i=e;if("mode"===i.id)return null==(t=this.settingDialogObserver)||t.disconnect(),void this.attachModeChangeListener(i);const s=i.querySelector("#mode");if(s)return null==(n=this.settingDialogObserver)||n.disconnect(),void this.attachModeChangeListener(s)}}),this.settingDialogObserver.observe(e,{childList:!0,subtree:!0}))}attachModeChangeListener(e){var t;null==(t=this.modeSelect)||t.removeEventListener("change",this.handleModeChange),this.modeSelect=e,this.modeSelect.addEventListener("change",this.handleModeChange)}handleSearchDialog(e){this.searchTipElements=[],this.addResizeMoveToSearchDialog(e);const t=document.getElementById("searchAssets");t&&(t.children.length>0?this.addResizeMoveToSearchDialog(t):(this.searchAssetsObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{var n;e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("search__tip")&&(null==(n=this.searchAssetsObserver)||n.disconnect(),this.searchAssetsObserver=null,this.addResizeMoveToSearchDialog(t))})})}),this.searchAssetsObserver.observe(t,{childList:!0})))}addResizeMoveToSearchDialog(e){e.querySelectorAll(".search__tip, .fn__flex-column > .block__icons").forEach(e=>{e.classList.add("resize__move"),this.searchTipElements.push(e)})}}class MobileFunctionality{constructor(){this.observer=null}init(){this.addMobileAIConfig()}destroy(){var e;this.observer&&(this.observer.disconnect(),this.observer=null),null==(e=document.getElementById("menuAI"))||e.remove();document.querySelectorAll(".b3-menu__separator[data-whisper-separator]").forEach(e=>{e.remove()})}addMobileAIConfig(){const e=document.getElementById("menu");e?(this.observer=new MutationObserver((e,t)=>{var n;const i=document.getElementById("menuRiffCard");if(i){null==t||t.disconnect();if(!document.getElementById("menuAI")){const e=`<div class="b3-menu__item${(null==(n=window.siyuan.config)?void 0:n.readonly)?" fn__none":""}" id="menuAI">\n                        <svg class="b3-menu__icon"><use xlink:href="#iconSparkles"></use></svg><span class="b3-menu__label">AI</span>\n                    </div>`;i.insertAdjacentHTML("afterend",e)}}}),this.observer.observe(e,{childList:!0,subtree:!0}),setTimeout(()=>{var e;null==(e=this.observer)||e.disconnect(),this.observer=null;document.getElementById("menuRiffCard")||n.error("menuRiffCard element does not exist.")},6e4)):n.error("mobileMenu element does not exist.")}}class EventBusManager{constructor(){this.themeName="whisper-theme",this.eventHandlers=new Map,this.eventBusHandler=e=>{var t,n;switch(e.type){case"loaded-protyle-static":{const i=null==(n=null==(t=e.detail.protyle)?void 0:t.wysiwyg)?void 0:n.element;if("NodeListItem"===(null==i?void 0:i.dataset.docType)){const e=i.querySelector(":scope > [data-node-id].li");e instanceof HTMLElement&&e.removeAttribute("fold")}break}}}}init(){["loaded-protyle-static"].forEach(e=>{this.eventBusOn(e,this.eventBusHandler)})}destroy(){this.eventHandlers.forEach((e,t)=>{this.eventBusOff(t,e)}),this.removeMyTheme()}getThisTheme(e=this.themeName){var t,n,i,s,o,r,a;const l=null==(i=null==(n=null==(t=window.siyuan.ws)?void 0:t.app)?void 0:n.plugins)?void 0:i.find(t=>t.name===e);if(l)return l;const c=document.createComment(e);document.appendChild(c);const d={name:e,app:(null==(o=null==(s=window.siyuan.ws)?void 0:s.app)?void 0:o.appId)||"",displayName:e,i18n:null,eventBus:{on:(e,t)=>{c.addEventListener(e,t)},once:(e,t)=>{c.addEventListener(e,t,{once:!0})},off:(e,t)=>{c.removeEventListener(e,t)},emit:(e,t)=>c.dispatchEvent(new CustomEvent(e,{detail:t,cancelable:!0}))},protyleSlash:[],topBarIcons:[],statusBarIcons:[],commands:[],models:{},docks:{},data:{},onload:()=>{},onunload:()=>{},uninstall:()=>{},updateCards:e=>e,onLayoutReady:()=>{},updateProtyleToolbar:e=>e};return(null==(a=null==(r=window.siyuan.ws)?void 0:r.app)?void 0:a.plugins)&&window.siyuan.ws.app.plugins.push(d),d}removeMyTheme(e=this.themeName){var t,n;if(null==(n=null==(t=window.siyuan.ws)?void 0:t.app)?void 0:n.plugins){const t=window.siyuan.ws.app.plugins.findIndex(t=>t.name===e);t>-1&&window.siyuan.ws.app.plugins.splice(t,1)}this.cleanupCommentNode(e)}cleanupCommentNode(e){const t=document.evaluate(`//comment()[.='${e}']`,document,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let n=0;n<t.snapshotLength;n++){const e=t.snapshotItem(n);e&&e.parentNode&&e.parentNode.removeChild(e)}}eventBusOn(e,t){const n=this.getThisTheme();this.eventHandlers.set(e,t),n.eventBus.on(e,t)}eventBusOff(e,t){this.getThisTheme().eventBus.off(e,t),this.eventHandlers.delete(e)}}const checkConnectivity=async()=>{try{return 0===(await(async()=>{try{const e=await fetch("/api/system/currentTime",{method:"POST"});return await e.json()}catch(e){return{code:500,msg:`Request exception:${e instanceof Error?e.message:String(e)}`,data:null}}})()).code}catch{return!1}};let i=null;const checkConnectivityWithCache=async()=>{const e=Date.now();if(i&&i.isConnected&&e-i.lastCheckTime<6e5)return!0;const t=await checkConnectivity();return i=t?{isConnected:!0,lastCheckTime:e}:null,t},getFile=async(e,t={})=>{const{retryOnConnectivityError:n=!1,retryInterval:i=3e4,maxRetries:s=50}=t;let o=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(n&&o<s){o++,await new Promise(e=>setTimeout(e,i));continue}return{code:503,msg:"Server connectivity check failed",data:null}}const t=await fetch("/api/file/getFile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})});return 200===t.status?await t.text():202===t.status?await t.json():{code:t.status,msg:`Unknown error, status code:${t.status}`,data:null}}catch(r){return{code:500,msg:`Request exception:${r instanceof Error?r.message:String(r)}`,data:null}}},s=class _FileOperationQueue{static enqueue(e,t){const i=(this.queues.get(e)||Promise.resolve()).then(t,t);return this.queues.set(e,i),i.catch(t=>{throw n.error(`Operation error for ${e}:`,t),t})}};s.queues=new Map;let o=s;class LocalConfig{constructor(e,t){this.configPath="/conf/whisper-theme-config.json",this.defaultConfig={version:1},isPublish()||(e&&(this.configPath=e),t&&(this.defaultConfig=t))}async init(){try{const e={retryOnConnectivityError:!0,retryInterval:5e3,maxRetries:100},t=await this.readConfig(e);0===Object.keys(t).length?await this.resetConfig(e):1!==t.version&&(t.version=1,await this.writeConfig(t,e))}catch{await this.resetConfig({retryOnConnectivityError:!0,retryInterval:5e3,maxRetries:10})}}async readConfig(e){return o.enqueue(this.configPath,async()=>{try{const t=await getFile(this.configPath,e||{});if("string"!=typeof t||""===t.trim())return{};return JSON.parse(t)||{}}catch(t){return n.error(`Failed to read configuration: ${t instanceof Error?t.message:String(t)}`),{}}})}async writeConfig(e,t){return isPublish()?(n.error("Writing configuration is not supported in publish service"),!1):o.enqueue(this.configPath,async()=>{try{const i=await(async(e,t={})=>{const{retryOnConnectivityError:n=!1,retryInterval:i=3e4,maxRetries:s=50}=t;let o=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(n&&o<s){o++,await new Promise(e=>setTimeout(e,i));continue}return{code:503,msg:"Server connectivity check failed",data:null}}if(window.siyuan.isPublish)return{code:403,msg:"You are not allowed to write files in published workspace",data:null};const r=new FormData;r.append("path",e),void 0!==t.isDir&&r.append("isDir",t.isDir.toString()),void 0!==t.modTime&&r.append("modTime",t.modTime.toString()),t.file&&!t.isDir&&r.append("file",t.file);const a=await fetch("/api/file/putFile",{method:"POST",body:r});return await a.json()}catch(r){return{code:500,msg:`Request exception:${r instanceof Error?r.message:String(r)}`,data:null}}})(this.configPath,{isDir:!1,modTime:Math.floor(Date.now()/1e3),file:new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),...t});return 0===i.code||(n.error(`Failed to save configuration: ${i.msg}`),!1)}catch(i){return n.error(`Save configuration exception: ${i instanceof Error?i.message:String(i)}`),!1}})}async get(e,t,i){try{const n=await this.readConfig(i),s=e.split(".").reduce((e,t)=>e&&"object"==typeof e?e[t]:void 0,n);return void 0!==s?s:t}catch(s){return n.error(`Error getting config value at path '${e}': ${s instanceof Error?s.message:String(s)}`),t}}async set(e,t,i){try{const n=await this.readConfig(i),s=e.split(".");let o=n;for(let e=0;e<s.length-1;e++){const t=s[e];o[t]&&"object"==typeof o[t]&&!Array.isArray(o[t])||(o[t]={}),o=o[t]}return o[s[s.length-1]]=t,await this.writeConfig(n,i)}catch(s){return n.error(`Error setting config value at path '${e}': ${s instanceof Error?s.message:String(s)}`),!1}}async batchUpdate(e,t){try{const n=await this.readConfig(t);for(const[t,i]of Object.entries(e)){const e=t.split(".");let s=n;for(let t=0;t<e.length-1;t++){const n=e[t];s[n]&&"object"==typeof s[n]&&!Array.isArray(s[n])||(s[n]={}),s=s[n]}s[e[e.length-1]]=i}return await this.writeConfig(n,t)}catch(i){return n.error(`Error during batch update: ${i instanceof Error?i.message:String(i)}`),!1}}async resetConfig(e){return n.info("Reset configuration to default values"),await this.writeConfig({...this.defaultConfig},e)}async getAll(e){return await this.readConfig(e)}async remove(e,t){try{const n=await this.readConfig(t),i=e.split(".");let s=n;const o=i.length-1;for(let e=0;e<o;e++){const t=i[e];if(void 0===s[t]||null===s[t]||"object"!=typeof s[t])return!0;s=s[t]}const r=i[o];return void 0===s[r]||(delete s[r],await this.writeConfig(n,t))}catch(i){return n.error(`Error removing config value at path '${e}': ${i instanceof Error?i.message:String(i)}`),!1}}async deleteConfigFile(e){return isPublish()?(n.error("Deleting configuration file is not supported in publish service"),!1):o.enqueue(this.configPath,async()=>{try{const t=await(async(e,t={})=>{const{retryOnConnectivityError:n=!1,retryInterval:i=3e4,maxRetries:s=50}=t;let o=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(n&&o<s){o++,await new Promise(e=>setTimeout(e,i));continue}return{code:503,msg:"Server connectivity check failed",data:null}}if(window.siyuan.isPublish)return{code:403,msg:"You are not allowed to delete files in published workspace",data:null};const t=await fetch("/api/file/removeFile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})});return await t.json()}catch(r){return{code:500,msg:`Request exception:${r instanceof Error?r.message:String(r)}`,data:null}}})(this.configPath,e||{});return 0===t.code?(n.info(`Configuration file deleted successfully: ${this.configPath}`),!0):(n.error(`Failed to delete configuration file: ${t.msg}`),!1)}catch(t){return n.error(`Delete configuration file exception: ${t instanceof Error?t.message:String(t)}`),!1}})}}const r="theme.googleAnalytics.lastSentTimestamp";class GoogleAnalytics{constructor(){var e,t;this.scriptId="whisper-theme-analytics",this.gaId="G-ZY75BR723S",this.themeVersion=null==(t=null==(e=window.siyuan.config)?void 0:e.appearance)?void 0:t.themeVer,this.lastSentTimestamp=0,this.dateISO="",this.checkIntervalId=null}async fetchThemeVersion(){try{const e=await getFile("/conf/appearance/themes/Whisper/theme.json");if("string"==typeof e){const t=JSON.parse(e);return void(this.themeVersion=t.version)}}catch{n.error("Failed to get theme version")}this.themeVersion="unknown-version"}async init(){var e,t;await new Promise(e=>setTimeout(e,5e3)),(null==(t=null==(e=window.siyuan.config)?void 0:e.system)?void 0:t.disableGoogleAnalytics)||window.siyuan.whisper.theme.googleAnalytics.disableGoogleAnalytics||(await this.checkAndSend(),this.checkIntervalId=window.setInterval(()=>{this.checkAndSend().catch(e=>{n.error("Failed to check and send analytics data:",e)})},6e4))}destroy(){null!==this.checkIntervalId&&(window.clearInterval(this.checkIntervalId),this.checkIntervalId=null);const e=document.getElementById(this.scriptId);e&&e.remove(),window.whisper_theme_gtag&&(window.whisper_theme_gtag=void 0)}async checkAndSend(){const e=Date.now();this.dateISO=(new Date).toISOString().split("T")[0];const t=new LocalConfig;await t.init();const n=await t.get(r,0,{retryOnConnectivityError:!0,retryInterval:2e4,maxRetries:60});void 0!==n&&e-n<18e5||(this.lastSentTimestamp=e,await t.set(r,this.lastSentTimestamp),this.initGA())}initGA(){var e;if(!document.getElementById(this.scriptId)){const e=document.createElement("script");e.id=this.scriptId,e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id="+this.gaId,document.head.appendChild(e)}if(!window.whisper_theme_gtag){let gtag=function(...e){window.dataLayer=window.dataLayer||[],window.dataLayer.push(arguments)};window.whisper_theme_gtag=gtag,gtag("js",new Date),gtag("config",this.gaId,{send_page_view:!1,user_id:null==(e=window.siyuan.user)?void 0:e.userId})}n.log("Sending Google Analytics data. https://github.com/TCOTC/Whisper/issues/11"),this.sendInfo()}async sendInfo(){var e,t,i,s,o,r;this.themeVersion||await this.fetchThemeVersion();const a={theme_version:this.themeVersion,date_iso:this.dateISO,timestamp:this.lastSentTimestamp,language:navigator.language};try{const n=window.siyuan;n&&((null==(e=n.config)?void 0:e.lang)&&(a.app_language=n.config.lang),(null==(t=n.config)?void 0:t.system)&&(a.app_version=n.config.system.kernelVersion,a.app_container=n.config.system.container,a.app_os=n.config.system.os,a.app_platform=n.config.system.osPlatform),(null==(i=n.config)?void 0:i.sync)&&(a.sync_enabled=n.config.sync.enabled),(null==(s=n.config)?void 0:s.stat)&&(a.user_create_time=null==(r=null==(o=n.user)?void 0:o.userCreateTime)?void 0:r.slice(0,6),a.tree_count=n.config.stat.cTreeCount,a.block_count=n.config.stat.cBlockCount))}catch(l){n.error("Error collecting SiYuan data for analytics:",l)}window.whisper_theme_gtag&&window.whisper_theme_gtag("event","theme_init",a)}trackEvent(e,t={}){window.whisper_theme_gtag&&(t.theme_version=this.themeVersion,window.whisper_theme_gtag("event",e,t))}trackFeatureUse(e,t={}){this.trackEvent("feature_use",{feature_name:e,...t})}}const showMessage=(e,t=6e3,n="info",i)=>{var s,o;let r=document.getElementById("message");if(!r)return;if(r=r.firstElementChild,!r)return void document.body.insertAdjacentHTML("beforeend",`<div style="top: 10px;\n    position: fixed;\n    z-index: 100;\n    background: white;\n    padding: 10px;\n    border-radius: 5px;\n    right: 10px;\n    border: 1px solid #e0e0e0;" id='tempMessage'>${e}</div>`);const a=([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),l=r.querySelector(`.b3-snackbar[data-id="${a}"]`),c=e+("error"===n?" v"+((null==(o=null==(s=window.siyuan.config)?void 0:s.system)?void 0:o.kernelVersion)??""):"");if(l){const e=l.getAttribute("data-timeoutid");if(e&&window.clearTimeout(parseInt(e)),l.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${0===t?" b3-snackbar__content--close":""}">${c}</div>${0===t?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,"error"===n?l.classList.add("b3-snackbar--error"):l.classList.remove("b3-snackbar--error"),t>0){const e=window.setTimeout(()=>{hideMessage(a)},t);l.setAttribute("data-timeoutid",e.toString())}return}let d=`<div data-id="${a}" class="b3-snackbar--hide b3-snackbar${"error"===n?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${0===t?" b3-snackbar__content--close":""}">${c}</div>`;if(0===t)d+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(-1!==t){const e=window.setTimeout(()=>{hideMessage(a)},t);d=d.replace("<div data-id",`<div data-timeoutid="${e}" data-id`)}r.parentElement&&(r.parentElement.classList.add("b3-snackbars--show"),r.parentElement.style.zIndex=((window.siyuan.zIndex??0)+1).toString()),r.insertAdjacentHTML("afterbegin",d+"</div>"),setTimeout(()=>{r.querySelectorAll(".b3-snackbar--hide").forEach(e=>{e.classList.remove("b3-snackbar--hide")})});const u=r.firstElementChild;return u&&u.nextElementSibling&&u.nextElementSibling.innerHTML===u.innerHTML&&u.nextElementSibling.remove(),r.scrollTo({top:0,behavior:"smooth"}),a},hideMessage=e=>{let t=document.getElementById("message");if(t&&(t=t.firstElementChild,t))if(e){const n=t.querySelector(`[data-id="${e}"]`);if(n){n.classList.add("b3-snackbar--hide");const e=n.getAttribute("data-timeoutid");e&&window.clearTimeout(parseInt(e)),setTimeout(()=>{n.remove(),0===t.childElementCount&&t.parentElement&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},256)}let i=!1;Array.from(t.children).find(e=>{if(!e.classList.contains("b3-snackbar--hide"))return i=!0,!0}),i&&t.parentElement?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement&&t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement&&(t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},256))};class ModuleManager{constructor(){this.modules=[]}register(e){this.modules.push(e)}initAll(){this.modules.forEach(e=>{"function"==typeof e.init&&e.init()})}async destroyAll(){for(let e=this.modules.length-1;e>=0;e--){const t=this.modules[e];if("function"==typeof t.destroy){const e=t.destroy();e instanceof Promise&&await e}}this.modules=[]}}(()=>{function debug(){isMobile()&&message("isMobile"),navigator.userAgent.indexOf("iPad")>-1&&message("isIPad"),isTouchDevice()&&message("isTouchDevice")}function message(e){showMessage(e,1e4,"info")}!function initGlobalVariables(){var e,t,n,i;(e=window.siyuan).whisper??(e.whisper={}),(t=window.siyuan.whisper).debug??(t.debug={}),(n=window.siyuan.whisper).theme??(n.theme={}),(i=window.siyuan.whisper.theme).googleAnalytics??(i.googleAnalytics={}),window.siyuan.whisper.loaded=!0}(),setTimeout(()=>{var e;(null==(e=window.siyuan.whisper.debug)?void 0:e.showMessage)&&debug()},5e3),n.log("Loaded");const e=new ModuleManager;e.register(new DeviceDetector),e.register(new BlockFocusHandler),e.register(new EventBusManager),isPublish()||e.register(new GoogleAnalytics),isMobile()?e.register(new MobileFunctionality):(e.register(new TooltipHandler),e.register(new ElementStatusObserver),e.register(new DialogHandler),e.register(new MenuHandler)),e.initAll(),window.destroyTheme=async()=>{await e.destroyAll(),window.siyuan.whisper.loaded=!1,n.log("Unloaded"),isPublish()||async function removeConfigFile(){var e,t,i,s;if(await new Promise(e=>setTimeout(e,6e4)),window.siyuan.whisper.loaded)return;const o=null==(t=null==(e=window.siyuan.config)?void 0:e.appearance)?void 0:t.lightThemes,r=null==(s=null==(i=window.siyuan.config)?void 0:i.appearance)?void 0:s.darkThemes;if(!o||!r)return;let a=!0;if(o.forEach(e=>{"Whisper"===e.name&&(a=!1)}),r.forEach(e=>{"Whisper"===e.name&&(a=!1)}),a)try{const e=new LocalConfig;await e.deleteConfigFile({retryOnConnectivityError:!0,retryInterval:3e3,maxRetries:5})?n.log("Uninstall. Theme config file removed successfully"):n.error("Uninstall. Failed to remove theme config file")}catch(l){n.error(`Uninstall. Error removing theme config file: ${l instanceof Error?l.message:String(l)}`)}}()}})()}();
