!function(){"use strict";const isPublish=()=>{var e;return!!(null==(e=window.siyuan)?void 0:e.isPublish)},isMobile=()=>{var e;return!!(null==(e=window.siyuan)?void 0:e.mobile)},isTouchDevice=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,isWindows=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,getThemeLight=()=>{var e,t,n;const i=null==(n=null==(t=null==(e=window.siyuan)?void 0:e.config)?void 0:t.appearance)?void 0:n.themeLight;return i||(document.documentElement.getAttribute("data-light-theme")||!1)},getThemeDark=()=>{var e,t,n;const i=null==(n=null==(t=null==(e=window.siyuan)?void 0:e.config)?void 0:t.appearance)?void 0:n.themeDark;return i||(document.documentElement.getAttribute("data-dark-theme")||!1)},getCurrentTheme=()=>{const e=(()=>{var e,t,n;const i=null==(n=null==(t=null==(e=window.siyuan)?void 0:e.config)?void 0:t.appearance)?void 0:n.mode;return i?0===i?"light":"dark":document.documentElement.getAttribute("data-theme-mode")||!1})(),t=getThemeLight(),n=getThemeDark();return!!(e&&t&&n)&&("light"===e?t:n)};class DeviceDetector{init(){this.addDeviceTypeAttribute()}destroy(){document.body.removeAttribute("data-whisper-device")}addDeviceTypeAttribute(){isMobile()?document.body.dataset.whisperDevice="mobile":navigator.platform.toUpperCase().indexOf("MAC")>-1?document.body.dataset.whisperDevice="mac":isWindows()&&(document.body.dataset.whisperDevice="windows")}}class BlockFocusHandler{constructor(){this.focusBlock=e=>{let t=null;if(document.activeElement instanceof HTMLElement&&(t=document.activeElement.closest(".protyle-wysiwyg")),!t)return;if(t.querySelector(".protyle-wysiwyg--select"))return void this.clearBlockFocusAttribute(t);let n=null;if(e.target instanceof HTMLElement){const t=e.target.closest("[data-node-id]");t instanceof HTMLElement&&(n=t)}if(!n&&e instanceof TouchEvent&&e.changedTouches&&e.changedTouches.length>0){const t=e.changedTouches[0],i=document.elementFromPoint(t.clientX,t.clientY);if(i instanceof HTMLElement){const e=i.closest("[data-node-id]");e instanceof HTMLElement&&(n=e)}}if(!n){const e=window.getSelection();if(!e||!e.anchorNode)return;const t=e.anchorNode.parentElement;t instanceof HTMLElement&&(n=t.closest("[data-node-id]"))}(null==n?void 0:n.hasAttribute("data-whisper-block-focus"))||(this.clearBlockFocusAttribute(t),n&&!n.closest(".protyle-wysiwyg__embed")&&(n.dataset.whisperBlockFocus=""))}}init(){document.addEventListener("mouseup",this.focusBlock,!0),document.addEventListener("keyup",this.focusBlock,!0),document.addEventListener("dragend",this.focusBlock,!0),document.addEventListener("touchend",this.focusBlock,!0),document.addEventListener("touchcancel",this.focusBlock,!0)}destroy(){document.removeEventListener("mouseup",this.focusBlock,!0),document.removeEventListener("keyup",this.focusBlock,!0),document.removeEventListener("dragend",this.focusBlock,!0),document.removeEventListener("touchend",this.focusBlock,!0),document.removeEventListener("touchcancel",this.focusBlock,!0),this.clearBlockFocusAttribute()}clearBlockFocusAttribute(e=document){e.querySelectorAll("[data-whisper-block-focus]").forEach(e=>{e instanceof HTMLElement&&delete e.dataset.whisperBlockFocus})}}const e=new class Logger{constructor(e){this.prefix="Whisper",e&&(this.prefix=e)}log(...e){console.log(`[${this.prefix}]`,...e)}error(...e){console.error(`[${this.prefix}]`,...e)}warn(...e){console.warn(`[${this.prefix}]`,...e)}info(...e){console.info(`[${this.prefix}]`,...e)}debug(...e){console.debug(`[${this.prefix}]`,...e)}};class ElementStatusObserver{constructor(){this.retryIntervalId=null,this.elementObserver=null,this.targets=[]}init(){this.setupTargets(),this.startObserving()}destroy(){this.retryIntervalId&&(clearInterval(this.retryIntervalId),this.retryIntervalId=null),this.elementObserver&&(this.elementObserver.disconnect(),this.elementObserver=null),setTimeout(()=>{"Whisper"!==getCurrentTheme()&&this.targets.forEach(e=>{e.found&&e.checks.forEach(e=>{const t=`data-${e.datasetProp.replace(/([A-Z])/g,"-$1").toLowerCase()}`;document.documentElement.removeAttribute(t)})})},3e3)}createBaseTarget(e,t,n){return{selector:e,checks:t,found:!1,timedOut:!1,element:null,exclude:n}}setupTargets(){this.targets=[this.createBaseTarget("#status",[{datasetProp:"whisperStatus",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}]),this.createBaseTarget("#dockLeft",[{datasetProp:"whisperDockLeft",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget("#dockRight",[{datasetProp:"whisperDockRight",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget("#dockBottom",[{datasetProp:"whisperDockBottom",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget(".layout__dockl",[{datasetProp:"whisperLayoutDockl",attributeFilter:"style",check:e=>"0px"===e.style.width,stateMap:{true:"hide",false:"show"}},{datasetProp:"whisperLayoutDocklFloat",attributeFilter:"class",check:e=>e.classList.contains("layout--float"),stateMap:{true:"float",false:"pin"}}],{selector:"body.body--window"}),this.createBaseTarget(".layout__dockr",[{datasetProp:"whisperLayoutDockr",attributeFilter:"style",check:e=>"0px"===e.style.width,stateMap:{true:"hide",false:"show"}},{datasetProp:"whisperLayoutDockrFloat",attributeFilter:"class",check:e=>e.classList.contains("layout--float"),stateMap:{true:"float",false:"pin"}}],{selector:"body.body--window"})]}startObserving(){this.elementObserver=new MutationObserver(e=>{for(const t of e){const e=t.target,n=this.targets.find(t=>t.element===e);n&&n.checks.forEach(n=>{if(n.attributeFilter===t.attributeName){const t=n.check(e);document.documentElement.dataset[n.datasetProp]=n.stateMap[String(t)]}})}});let t=0;this.retryIntervalId=window.setInterval(()=>{t++;let n=!1;this.targets.forEach(i=>{if(i.found||i.timedOut)return;let s=!1;if(i.exclude){const e=document.querySelector(i.exclude.selector);e&&(s=!i.exclude.check||i.exclude.check(e))}if(s)return void(i.timedOut=!0);const o=document.querySelector(i.selector);o?(i.element=o,i.found=!0,this.setupObserver(i)):t>=50?(i.timedOut=!0,e.error(`failed to find target node: ${i.selector}`)):n=!0}),(!n||t>=50)&&this.retryIntervalId&&(clearInterval(this.retryIntervalId),this.retryIntervalId=null)},100)}setupObserver(e){if(!e.element||!this.elementObserver)return;e.checks.forEach(t=>{const n=t.check(e.element);document.documentElement.dataset[t.datasetProp]=t.stateMap[String(n)]});const t=Array.from(new Set(e.checks.map(e=>e.attributeFilter)));this.elementObserver.observe(e.element,{attributes:!0,attributeFilter:t})}}class TooltipHandler{constructor(){this.tooltipElement=null,this.updateTooltipData=async e=>{if(!e.target||9===e.target.nodeType)return;if(!this.tooltipElement)return void(await this.getTooltipElement());const t=3===e.target.nodeType?e.target.parentElement:e.target;if(t.closest('[data-type="navigation-file"]'))return void this.removeTooltipData();const n=t.getAttribute("data-href");if(n)return(e=>{if(!e)return!1;if(1>(e=e.trim()).length)return!1;if((e=e.toLowerCase()).startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\"))return!0;if(isWindows())return 1===e.indexOf(":");return e.startsWith("/")})(n)?void this.setTooltipData("href_asset"):void this.setTooltipData("href",!0);t.closest('[data-type="tab-header"]')?this.setTooltipData("tab_header",!0):t.closest(".av__cell")||t.closest('[data-type="addColOptionOrCell"]')||t.closest('[data-type="av-add"]')||t.closest('[data-type="av-add-more"]')||t.closest('[data-type="av-header-add"]')||t.closest("[data-page]")?this.setTooltipData("av"):t.classList.contains("emojis__item")||t.classList.contains("emojis__type")?this.setTooltipData("emoji"):this.tooltipElement&&!this.tooltipElement.classList.contains("fn__none")&&(this.tooltipElement.dataset.whisperTooltip="")}}async getTooltipElement(){this.tooltipElement||(this.tooltipElement=document.getElementById("tooltip"))}async init(){await this.getTooltipElement(),this.tooltipElement||e.error("tooltip element does not exist."),document.addEventListener("mouseover",this.updateTooltipData)}async destroy(){var e;document.removeEventListener("mouseover",this.updateTooltipData),await this.getTooltipElement(),null==(e=this.tooltipElement)||e.removeAttribute("data-whisper-tooltip"),this.tooltipElement=null}setTooltipData(e,t=!1){var n;if(this.tooltipElement)if((null==(n=this.tooltipElement.dataset)?void 0:n.whisperTooltip)!==e&&(this.tooltipElement.dataset.whisperTooltip=e),t){const e=this.tooltipElement.getAttribute("style")||"";this.tooltipElement.setAttribute("style",`${e} display: flex !important`)}else this.tooltipElement.style.removeProperty("display")}removeTooltipData(e){var t;this.tooltipElement&&(e&&(null==(t=this.tooltipElement.dataset)?void 0:t.whisperTooltip)!==e||(this.tooltipElement.dataset.whisperTooltip=""))}}function themeSwitch(t,n){var i,s,o,r,a,l,c;switch(t){case"commonMenu":{const t=null==(i=window.siyuan)?void 0:i.languages;if(!t)return void e.error("window.siyuan.languages is not available");const{themeLight:a,themeDark:l,themeOS:c}=t;if(!a||!l||!c)return void e.error("Theme mode variables are not properly defined");const d=n.target.closest(".b3-menu__item");if(!d)return;let u=d.textContent||"";u===c&&(u=window.matchMedia("(prefers-color-scheme: light)").matches?a:l);if(u===(0===(null==(r=null==(o=null==(s=window.siyuan)?void 0:s.config)?void 0:o.appearance)?void 0:r.mode)?a:l))return;if("Whisper"!==(u===a?getThemeLight():getThemeDark()))return;break}case"dialog":{const e=n.target.closest("#mode");if(!e)return;const t=parseInt(e.value),i=2===t?"light"==(window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark")?0:1:t;if(i===(null==(c=null==(l=null==(a=window.siyuan)?void 0:a.config)?void 0:l.appearance)?void 0:c.mode))return;if("Whisper"!==(0===i?getThemeLight():getThemeDark()))return;break}default:return}!function applyAnimation(t){if(!document.startViewTransition)return void e.error("View Transitions API is not supported");const n=document.startViewTransition(),i=t.clientX,s=t.clientY,o=Math.hypot(Math.max(i,window.innerWidth-i),Math.max(s,window.innerHeight-s)),r=document.createElement("style");r.innerHTML="::view-transition-old(root),::view-transition-new(root){animation: none;}",document.head.appendChild(r),n.ready.then(()=>{const e=document.documentElement.animate({clipPath:[`circle(0 at ${i}px ${s}px)`,`circle(${o}px at ${i}px ${s}px)`]},{duration:550,pseudoElement:"::view-transition-new(root)",easing:"ease-in-out"}),clickHandler=()=>{e.finish()};document.addEventListener("click",clickHandler),e.onfinish=()=>{document.removeEventListener("click",clickHandler),setTimeout(()=>{null==r||r.remove()})}})}(n)}class MenuHandler{constructor(){this.commonMenuObserver=null,this.commonMenu=null,this.whisperCommonMenu=null,this.handleMenuClick=e=>{var t;"barmode"===((null==(t=e.target.closest("#commonMenu"))?void 0:t.getAttribute("data-name"))||"")&&themeSwitch("commonMenu",e)},this.handleCloseClick=e=>{e.target instanceof HTMLElement&&!e.target.closest(".b3-menu__submenu")&&(e.preventDefault(),e.stopPropagation())}}init(){this.setupMenuObserver()}destroy(){this.commonMenuObserver&&(this.commonMenuObserver.disconnect(),this.commonMenuObserver=null),this.commonMenu&&(this.commonMenu.removeEventListener("click",this.handleMenuClick,!0),this.commonMenu.removeEventListener("click",this.handleCloseClick,!0),this.commonMenu=null),this.whisperCommonMenu&&(this.whisperCommonMenu.remove(),this.whisperCommonMenu=null)}setupMenuObserver(){if(this.commonMenu=document.getElementById("commonMenu"),!this.commonMenu)return void e.error("commonMenu element does not exist.");const t=document.createElement("div");t.id="whisperCommonMenu",this.commonMenu.insertAdjacentElement("beforebegin",t),this.whisperCommonMenu=t,this.commonMenuObserver=new MutationObserver(e=>{let t=!1;e.forEach(()=>{var e,n,i,s;t||(this.commonMenu&&(this.commonMenu.removeEventListener("click",this.handleMenuClick,!0),this.commonMenu.removeEventListener("click",this.handleCloseClick,!0)),this.whisperCommonMenu&&(this.whisperCommonMenu.dataset.name=""),"barmode"===(null==(e=this.commonMenu)?void 0:e.getAttribute("data-name"))?this.commonMenu.addEventListener("click",this.handleMenuClick,!0):(null==(n=this.commonMenu)?void 0:n.querySelector('[data-id="close"]'))&&(null==(i=this.commonMenu)?void 0:i.querySelector('[data-id="split"]'))&&(null==(s=this.commonMenu)?void 0:s.querySelector('[data-id="copy"]'))&&(this.whisperCommonMenu&&(this.whisperCommonMenu.dataset.name="tab-header"),this.handleTabClose()),t=!0)})}),this.commonMenuObserver.observe(this.commonMenu,{attributes:!0})}handleTabClose(){var e,t;if(!this.commonMenu)return;const n=this.commonMenu.querySelector('[data-id="close"]');if(!n)return;isTouchDevice()&&this.commonMenu.addEventListener("click",this.handleCloseClick,!0);const i=n.cloneNode(!0);null==(e=i.querySelector(".b3-menu__icon"))||e.remove(),null==(t=n.querySelector(".b3-menu__accelerator"))||t.remove(),n.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg><div class="b3-menu__submenu"><div class="b3-menu__items"></div></div>');const s=n.querySelector(".b3-menu__items");if(!s)return;s.appendChild(i),this.commonMenu.querySelectorAll('[data-id="closeOthers"], [data-id="closeAll"], [data-id="closeUnmodified"], [data-id="closeLeft"], [data-id="closeRight"]').forEach(e=>{var t;null==(t=e.querySelector(".b3-menu__icon"))||t.remove(),s.appendChild(e)});const o=this.commonMenu.querySelector('[data-id="split"] > .b3-menu__icon > use');o&&o.setAttribute("xlink:href","#iconSplitLR")}}class DialogHandler{constructor(){this.bodyObserver=null,this.searchAssetsObserver=null,this.searchTipElements=[],this.settingDialogObserver=null,this.modeSelect=null,this.handleModeChange=e=>{const t=e.target;if(t&&"mode"===t.id){const e=t.getBoundingClientRect(),n=e.left+e.width/2,i=e.top+e.height/2+30,s=new MouseEvent("click",{clientX:n,clientY:i,bubbles:!0,cancelable:!0});Object.defineProperty(s,"target",{value:t,enumerable:!0}),themeSwitch("dialog",s)}}}init(){document.querySelectorAll(".b3-dialog--open").forEach(e=>{this.handleDialogOpen(e)}),this.setupBodyObserver()}destroy(){var e,t,n,i;null==(e=this.bodyObserver)||e.disconnect(),this.bodyObserver=null,null==(t=this.settingDialogObserver)||t.disconnect(),this.settingDialogObserver=null,null==(n=this.modeSelect)||n.removeEventListener("change",this.handleModeChange),this.modeSelect=null,null==(i=this.searchAssetsObserver)||i.disconnect(),this.searchAssetsObserver=null,this.searchTipElements.forEach(e=>{e.classList.remove("resize__move")}),this.searchTipElements=[]}setupBodyObserver(){this.bodyObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&setTimeout(()=>{const t=e;t.classList.contains("b3-dialog--open")&&this.handleDialogOpen(t)})})})}),this.bodyObserver.observe(document.body,{childList:!0})}handleDialogOpen(e){switch(e.dataset.key){case"dialog-setting":this.setupThemeChangeListener(e);break;case"dialog-globalsearch":case"dialog-search":this.handleSearchDialog(e);break;default:return}}setupThemeChangeListener(e){const t=e.querySelector("#mode");t?this.attachModeChangeListener(t):(this.settingDialogObserver=new MutationObserver(e=>{var t,n;for(const i of e)for(const e of i.addedNodes){if(e.nodeType!==Node.ELEMENT_NODE)continue;const i=e;if("mode"===i.id)return null==(t=this.settingDialogObserver)||t.disconnect(),void this.attachModeChangeListener(i);const s=i.querySelector("#mode");if(s)return null==(n=this.settingDialogObserver)||n.disconnect(),void this.attachModeChangeListener(s)}}),this.settingDialogObserver.observe(e,{childList:!0,subtree:!0}))}attachModeChangeListener(e){var t;null==(t=this.modeSelect)||t.removeEventListener("change",this.handleModeChange),this.modeSelect=e,this.modeSelect.addEventListener("change",this.handleModeChange)}handleSearchDialog(e){this.searchTipElements=[],this.addResizeMoveToSearchDialog(e);const t=document.getElementById("searchAssets");t&&(t.children.length>0?this.addResizeMoveToSearchDialog(t):(this.searchAssetsObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{var n;e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("search__tip")&&(null==(n=this.searchAssetsObserver)||n.disconnect(),this.searchAssetsObserver=null,this.addResizeMoveToSearchDialog(t))})})}),this.searchAssetsObserver.observe(t,{childList:!0})))}addResizeMoveToSearchDialog(e){e.querySelectorAll(".search__tip, .fn__flex-column > .block__icons").forEach(e=>{e.classList.add("resize__move"),this.searchTipElements.push(e)})}}class MobileFunctionality{constructor(){this.observer=null}init(){this.addMobileAIConfig()}destroy(){var e;this.observer&&(this.observer.disconnect(),this.observer=null),null==(e=document.getElementById("menuAI"))||e.remove();document.querySelectorAll(".b3-menu__separator[data-whisper-separator]").forEach(e=>{e.remove()})}addMobileAIConfig(){const t=document.getElementById("menu");t?(this.observer=new MutationObserver((e,t)=>{var n,i;const s=document.getElementById("menuRiffCard");if(s){null==t||t.disconnect();if(!document.getElementById("menuAI")){const e=`<div class="b3-menu__item${(null==(i=null==(n=window.siyuan)?void 0:n.config)?void 0:i.readonly)?" fn__none":""}" id="menuAI">\n                        <svg class="b3-menu__icon"><use xlink:href="#iconSparkles"></use></svg><span class="b3-menu__label">AI</span>\n                    </div>`;s.insertAdjacentHTML("afterend",e)}setTimeout(()=>{this.addSeparator()},1e3)}}),this.observer.observe(t,{childList:!0,subtree:!0}),setTimeout(()=>{var t;null==(t=this.observer)||t.disconnect(),this.observer=null;document.getElementById("menuRiffCard")||e.error("menuRiffCard element does not exist.")},6e4)):e.error("mobileMenu element does not exist.")}addSeparator(){const e=document.getElementById("menuAbout");e&&e.insertAdjacentHTML("afterend",'<div class="b3-menu__separator" data-whisper-separator></div>')}}class EventBusManager{constructor(){this.themeName="whisper-theme",this.eventHandlers=new Map,this.eventBusHandler=e=>{var t,n;switch(e.type){case"loaded-protyle-static":{const i=null==(n=null==(t=e.detail.protyle)?void 0:t.wysiwyg)?void 0:n.element;if("NodeListItem"===(null==i?void 0:i.dataset.docType)){const e=i.querySelector(":scope > [data-node-id].li");e instanceof HTMLElement&&e.removeAttribute("fold")}break}}}}init(){["loaded-protyle-static"].forEach(e=>{this.eventBusOn(e,this.eventBusHandler)})}destroy(){this.eventHandlers.forEach((e,t)=>{this.eventBusOff(t,e)}),this.removeMyTheme()}getThisTheme(e=this.themeName){var t,n,i,s,o,r,a,l,c,d;const u=null==(s=null==(i=null==(n=null==(t=window.siyuan)?void 0:t.ws)?void 0:n.app)?void 0:i.plugins)?void 0:s.find(t=>t.name===e);if(u)return u;const h=document.createComment(e);document.appendChild(h);const m={name:e,app:(null==(a=null==(r=null==(o=window.siyuan)?void 0:o.ws)?void 0:r.app)?void 0:a.appId)||"",displayName:e,i18n:null,eventBus:{on:(e,t)=>{h.addEventListener(e,t)},once:(e,t)=>{h.addEventListener(e,t,{once:!0})},off:(e,t)=>{h.removeEventListener(e,t)},emit:(e,t)=>h.dispatchEvent(new CustomEvent(e,{detail:t,cancelable:!0}))},protyleSlash:[],topBarIcons:[],statusBarIcons:[],commands:[],models:{},docks:{},data:{},onload:()=>{},onunload:()=>{},uninstall:()=>{},updateCards:e=>e,onLayoutReady:()=>{},updateProtyleToolbar:e=>e};return(null==(d=null==(c=null==(l=window.siyuan)?void 0:l.ws)?void 0:c.app)?void 0:d.plugins)&&window.siyuan.ws.app.plugins.push(m),m}removeMyTheme(e=this.themeName){var t,n,i;if(null==(i=null==(n=null==(t=window.siyuan)?void 0:t.ws)?void 0:n.app)?void 0:i.plugins){const t=window.siyuan.ws.app.plugins.findIndex(t=>t.name===e);t>-1&&window.siyuan.ws.app.plugins.splice(t,1)}this.cleanupCommentNode(e)}cleanupCommentNode(e){const t=document.evaluate(`//comment()[.='${e}']`,document,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let n=0;n<t.snapshotLength;n++){const e=t.snapshotItem(n);e&&e.parentNode&&e.parentNode.removeChild(e)}}eventBusOn(e,t){const n=this.getThisTheme();this.eventHandlers.set(e,t),n.eventBus.on(e,t)}eventBusOff(e,t){this.getThisTheme().eventBus.off(e,t),this.eventHandlers.delete(e)}}const checkConnectivity=async()=>{try{return 0===(await(async()=>{try{const e=await fetch("/api/system/currentTime",{method:"POST"});return await e.json()}catch(e){return{code:500,msg:`Request exception:${e instanceof Error?e.message:String(e)}`,data:null}}})()).code}catch{return!1}};let t=null;const checkConnectivityWithCache=async()=>{const e=Date.now();if(t&&t.isConnected&&e-t.lastCheckTime<6e5)return!0;const n=await checkConnectivity();return t=n?{isConnected:!0,lastCheckTime:e}:null,n},getFile=async(e,t={})=>{const{retryOnConnectivityError:n=!1,retryInterval:i=3e4,maxRetries:s=50}=t;let o=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(n&&o<s){o++,await new Promise(e=>setTimeout(e,i));continue}return{code:503,msg:"Server connectivity check failed",data:null}}const t=await fetch("/api/file/getFile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})});return 200===t.status?await t.text():202===t.status?await t.json():{code:t.status,msg:`Unknown error, status code:${t.status}`,data:null}}catch(r){return{code:500,msg:`Request exception:${r instanceof Error?r.message:String(r)}`,data:null}}},n=class _FileOperationQueue{static enqueue(t,n){const i=(this.queues.get(t)||Promise.resolve()).then(n,n);return this.queues.set(t,i),i.catch(n=>{throw e.error(`Operation error for ${t}:`,n),n})}};n.queues=new Map;let i=n;class LocalConfig{constructor(e,t){this.configPath="/conf/whisper-theme-config.json",this.defaultConfig={version:1},isPublish()?this.initPromise=Promise.resolve():(e&&(this.configPath=e),t&&(this.defaultConfig=t),this.initPromise=this.init())}async init(){try{const e={retryOnConnectivityError:!0,retryInterval:5e3,maxRetries:100},t=await this.readConfig(e);0===Object.keys(t).length?await this.resetConfig(e):1!==t.version&&(t.version=1,await this.writeConfig(t,e))}catch{await this.resetConfig({retryOnConnectivityError:!0,retryInterval:5e3,maxRetries:10})}}async readConfig(t){return i.enqueue(this.configPath,async()=>{try{const e=await getFile(this.configPath,t||{});if("string"!=typeof e||""===e.trim())return{};return JSON.parse(e)||{}}catch(n){return e.error(`Failed to read configuration: ${n instanceof Error?n.message:String(n)}`),{}}})}async writeConfig(t,n){return isPublish()?(e.error("Writing configuration is not supported in publish service"),!1):i.enqueue(this.configPath,async()=>{try{const i=await(async(e,t={})=>{var n;const{retryOnConnectivityError:i=!1,retryInterval:s=3e4,maxRetries:o=50}=t;let r=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(i&&r<o){r++,await new Promise(e=>setTimeout(e,s));continue}return{code:503,msg:"Server connectivity check failed",data:null}}if(null==(n=window.siyuan)?void 0:n.isPublish)return{code:403,msg:"You are not allowed to write files in published workspace",data:null};const a=new FormData;a.append("path",e),void 0!==t.isDir&&a.append("isDir",t.isDir.toString()),void 0!==t.modTime&&a.append("modTime",t.modTime.toString()),t.file&&!t.isDir&&a.append("file",t.file);const l=await fetch("/api/file/putFile",{method:"POST",body:a});return await l.json()}catch(a){return{code:500,msg:`Request exception:${a instanceof Error?a.message:String(a)}`,data:null}}})(this.configPath,{isDir:!1,modTime:Math.floor(Date.now()/1e3),file:new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),...n});return 0===i.code||(e.error(`Failed to save configuration: ${i.msg}`),!1)}catch(i){return e.error(`Save configuration exception: ${i instanceof Error?i.message:String(i)}`),!1}})}async get(t,n,i){try{await this.initPromise;const e=await this.readConfig(i),s=t.split(".").reduce((e,t)=>e&&"object"==typeof e?e[t]:void 0,e);return void 0!==s?s:n}catch(s){return e.error(`Error getting config value at path '${t}': ${s instanceof Error?s.message:String(s)}`),n}}async set(t,n,i){try{await this.initPromise;const e=await this.readConfig(i),s=t.split(".");let o=e;for(let t=0;t<s.length-1;t++){const e=s[t];o[e]&&"object"==typeof o[e]&&!Array.isArray(o[e])||(o[e]={}),o=o[e]}return o[s[s.length-1]]=n,await this.writeConfig(e,i)}catch(s){return e.error(`Error setting config value at path '${t}': ${s instanceof Error?s.message:String(s)}`),!1}}async batchUpdate(t,n){try{await this.initPromise;const e=await this.readConfig(n);for(const[n,i]of Object.entries(t)){const t=n.split(".");let s=e;for(let e=0;e<t.length-1;e++){const n=t[e];s[n]&&"object"==typeof s[n]&&!Array.isArray(s[n])||(s[n]={}),s=s[n]}s[t[t.length-1]]=i}return await this.writeConfig(e,n)}catch(i){return e.error(`Error during batch update: ${i instanceof Error?i.message:String(i)}`),!1}}async resetConfig(t){return e.info("Reset configuration to default values"),await this.writeConfig({...this.defaultConfig},t)}async getAll(e){return await this.initPromise,await this.readConfig(e)}async remove(t,n){try{await this.initPromise;const e=await this.readConfig(n),i=t.split(".");let s=e;const o=i.length-1;for(let t=0;t<o;t++){const e=i[t];if(void 0===s[e]||null===s[e]||"object"!=typeof s[e])return!0;s=s[e]}const r=i[o];return void 0===s[r]||(delete s[r],await this.writeConfig(e,n))}catch(i){return e.error(`Error removing config value at path '${t}': ${i instanceof Error?i.message:String(i)}`),!1}}}const s="theme.googleAnalytics.lastSentTimestamp";class GoogleAnalytics{constructor(){var e,t,n;this.scriptId="whisper-theme-analytics",this.gaId="G-ZY75BR723S",this.themeVersion=null==(n=null==(t=null==(e=window.siyuan)?void 0:e.config)?void 0:t.appearance)?void 0:n.themeVer,this.lastSentTimestamp=0,this.dateISO="",this.checkIntervalId=null}async fetchThemeVersion(){try{const e=await getFile("/conf/appearance/themes/Whisper/theme.json");if("string"==typeof e){const t=JSON.parse(e);return void(this.themeVersion=t.version)}}catch{e.error("Failed to get theme version")}this.themeVersion="unknown-version"}async init(){var t,n,i;(null==(i=null==(n=null==(t=window.siyuan)?void 0:t.config)?void 0:n.system)?void 0:i.disableGoogleAnalytics)||(await this.checkAndSend(),this.checkIntervalId=window.setInterval(()=>{this.checkAndSend().catch(t=>{e.error("Failed to check and send analytics data:",t)})},6e4))}destroy(){null!==this.checkIntervalId&&(window.clearInterval(this.checkIntervalId),this.checkIntervalId=null);const e=document.getElementById(this.scriptId);e&&e.remove(),window.whisper_theme_gtag&&(window.whisper_theme_gtag=void 0)}async checkAndSend(){const e=Date.now();this.dateISO=(new Date).toISOString().split("T")[0];const t=new LocalConfig,n=await t.get(s,0,{retryOnConnectivityError:!0,retryInterval:2e4,maxRetries:60});void 0!==n&&e-n<18e5||(this.lastSentTimestamp=e,await t.set(s,this.lastSentTimestamp),this.initGA())}initGA(){var e,t,n,i;if(!document.getElementById(this.scriptId)){const e=document.createElement("script");e.id=this.scriptId,e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id="+this.gaId,document.head.appendChild(e)}if(!window.whisper_theme_gtag){let gtag=function(...e){window.dataLayer=window.dataLayer||[],window.dataLayer.push(arguments)};window.whisper_theme_gtag=gtag,gtag("js",new Date),gtag("config",this.gaId,{send_page_view:!1,user_id:(null==(t=null==(e=window.siyuan)?void 0:e.user)?void 0:t.userId)||"anonymous",user_name:(null==(i=null==(n=window.siyuan)?void 0:n.user)?void 0:i.userName)||"anonymous"})}console.log("Sending Google Analytics data"),this.sendInfo()}async sendInfo(){var t,n,i;this.themeVersion||await this.fetchThemeVersion();const s={theme_version:this.themeVersion,screen_width:window.innerWidth,screen_height:window.innerHeight,pixel_ratio:window.devicePixelRatio,language:navigator.language,date_iso:this.dateISO,timestamp:this.lastSentTimestamp};try{const e=window.siyuan;e&&((null==(t=e.config)?void 0:t.system)&&(s.app_version=e.config.system.kernelVersion,s.app_container=e.config.system.container,s.app_os=e.config.system.os,s.app_platform=e.config.system.osPlatform),e.user?(s.is_logged_in=!0,s.subscription_status=e.user.userSiYuanSubscriptionStatus,s.subscription_plan=e.user.userSiYuanSubscriptionPlan,s.subscription_type=e.user.userSiYuanSubscriptionType,s.one_time_pay_status=e.user.userSiYuanOneTimePayStatus):s.is_logged_in=!1,(null==(n=e.config)?void 0:n.sync)&&(s.sync_enabled=e.config.sync.enabled,s.sync_provider=e.config.sync.provider),(null==(i=e.config)?void 0:i.stat)&&(s.tree_count=e.config.stat.cTreeCount,s.block_count=e.config.stat.cBlockCount,s.data_size=e.config.stat.cDataSize,s.assets_size=e.config.stat.cAssetsSize))}catch(o){e.error("Error collecting SiYuan data for analytics:",o)}window.whisper_theme_gtag&&window.whisper_theme_gtag("event","theme_init",s)}trackEvent(e,t={}){window.whisper_theme_gtag&&(t.theme_version=this.themeVersion,window.whisper_theme_gtag("event",e,t))}trackFeatureUse(e,t={}){this.trackEvent("feature_use",{feature_name:e,...t})}}const showMessage=(e,t=6e3,n="info",i)=>{var s,o;let r=document.getElementById("message");if(!r)return;if(r=r.firstElementChild,!r)return void document.body.insertAdjacentHTML("beforeend",`<div style="top: 10px;\n    position: fixed;\n    z-index: 100;\n    background: white;\n    padding: 10px;\n    border-radius: 5px;\n    right: 10px;\n    border: 1px solid #e0e0e0;" id='tempMessage'>${e}</div>`);const a=([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),l=r.querySelector(`.b3-snackbar[data-id="${a}"]`),c=e+("error"===n?" v"+((null==(s=window.siyuan)?void 0:s.version)??""):"");if(l){const e=l.getAttribute("data-timeoutid");if(e&&window.clearTimeout(parseInt(e)),l.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${0===t?" b3-snackbar__content--close":""}">${c}</div>${0===t?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,"error"===n?l.classList.add("b3-snackbar--error"):l.classList.remove("b3-snackbar--error"),t>0){const e=window.setTimeout(()=>{hideMessage(a)},t);l.setAttribute("data-timeoutid",e.toString())}return}let d=`<div data-id="${a}" class="b3-snackbar--hide b3-snackbar${"error"===n?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${0===t?" b3-snackbar__content--close":""}">${c}</div>`;if(0===t)d+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(-1!==t){const e=window.setTimeout(()=>{hideMessage(a)},t);d=d.replace("<div data-id",`<div data-timeoutid="${e}" data-id`)}r.parentElement&&(r.parentElement.classList.add("b3-snackbars--show"),r.parentElement.style.zIndex=(((null==(o=window.siyuan)?void 0:o.zIndex)??0)+1).toString()),r.insertAdjacentHTML("afterbegin",d+"</div>"),setTimeout(()=>{r.querySelectorAll(".b3-snackbar--hide").forEach(e=>{e.classList.remove("b3-snackbar--hide")})});const u=r.firstElementChild;return u&&u.nextElementSibling&&u.nextElementSibling.innerHTML===u.innerHTML&&u.nextElementSibling.remove(),r.scrollTo({top:0,behavior:"smooth"}),a},hideMessage=e=>{let t=document.getElementById("message");if(t&&(t=t.firstElementChild,t))if(e){const n=t.querySelector(`[data-id="${e}"]`);if(n){n.classList.add("b3-snackbar--hide");const e=n.getAttribute("data-timeoutid");e&&window.clearTimeout(parseInt(e)),setTimeout(()=>{n.remove(),0===t.childElementCount&&t.parentElement&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},256)}let i=!1;Array.from(t.children).find(e=>{if(!e.classList.contains("b3-snackbar--hide"))return i=!0,!0}),i&&t.parentElement?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement&&t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement&&(t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},256))};class ModuleManager{constructor(){this.modules=[]}register(e){this.modules.push(e)}initAll(){this.modules.forEach(e=>{"function"==typeof e.init&&e.init()})}async destroyAll(){for(let e=this.modules.length-1;e>=0;e--){const t=this.modules[e];"function"==typeof t.destroy&&await Promise.resolve(t.destroy())}this.modules=[]}}(()=>{function debug(){isMobile()&&message("isMobile"),navigator.userAgent.indexOf("iPad")>-1&&message("isIPad"),isTouchDevice()&&message("isTouchDevice")}function message(e){showMessage(e,1e4,"info")}window.siyuan=window.siyuan||{},window.siyuan.whisper=window.siyuan.whisper||{},window.siyuan.whisper.debug=window.siyuan.whisper.debug||{},setTimeout(()=>{var e,t,n;(null==(n=null==(t=null==(e=window.siyuan)?void 0:e.whisper)?void 0:t.debug)?void 0:n.showMessage)&&debug()},5e3),e.log("loaded");const t=new ModuleManager;t.register(new DeviceDetector),t.register(new BlockFocusHandler),t.register(new EventBusManager),isPublish()||t.register(new GoogleAnalytics),isMobile()?t.register(new MobileFunctionality):(t.register(new TooltipHandler),t.register(new ElementStatusObserver),t.register(new DialogHandler),t.register(new MenuHandler)),t.initAll(),window.destroyTheme=async()=>{await t.destroyAll(),e.log("unloaded")}})()}();
//# sourceMappingURL=theme.js.map
