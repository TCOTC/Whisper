!function(){"use strict";const isPublish=()=>!!window.siyuan.isPublish,isMobile=()=>!!window.siyuan.mobile,isTouchDevice=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,isWindows=()=>navigator.platform.toUpperCase().indexOf("WIN")>-1,e="light",t="dark",getThemeCurrentMode=()=>{const n=window.siyuan.config?.appearance?.mode;return n?0===n?e:t:document.documentElement.getAttribute("data-theme-mode")||""},getOSThemeModeValue=()=>window.matchMedia("(prefers-color-scheme: light)").matches?0:1,getCurrentTheme=(n=getThemeCurrentMode())=>n===e?getCurrentThemeLight():n===t?getCurrentThemeDark():"",getCurrentThemeByValue=e=>0===e?getCurrentThemeLight():1===e?getCurrentThemeDark():2===e?getCurrentThemeByValue(getOSThemeModeValue()):"",getCurrentThemeLight=()=>{const e=window.siyuan.config?.appearance?.themeLight;return e||(document.documentElement.getAttribute("data-light-theme")||"")},getCurrentThemeDark=()=>{const e=window.siyuan.config?.appearance?.themeDark;return e||(document.documentElement.getAttribute("data-dark-theme")||"")};class DeviceDetector{init(){this.addDeviceTypeAttribute()}destroy(){document.body.removeAttribute("data-whisper-device")}addDeviceTypeAttribute(){isMobile()?document.body.dataset.whisperDevice="mobile":navigator.platform.toUpperCase().indexOf("MAC")>-1?document.body.dataset.whisperDevice="mac":isWindows()&&(document.body.dataset.whisperDevice="windows")}}class BlockFocusHandler{constructor(){this.focusBlock=async e=>{let t=null;if(document.activeElement instanceof HTMLElement&&(t=document.activeElement.closest(".protyle-wysiwyg")),!t)return;if(t.querySelector(".protyle-wysiwyg--select"))return void this.clearBlockFocusAttribute(t);let n=null;if(e.target instanceof HTMLElement){const t=e.target.closest("[data-node-id]");t instanceof HTMLElement&&(n=t)}if(!n&&e instanceof TouchEvent&&e.changedTouches&&e.changedTouches.length>0){const t=e.changedTouches[0],s=document.elementFromPoint(t.clientX,t.clientY);if(s instanceof HTMLElement){const e=s.closest("[data-node-id]");e instanceof HTMLElement&&(n=e)}}if(!n){await new Promise(e=>setTimeout(e,10));const e=window.getSelection();if(!e||!e.anchorNode)return;const t=e.anchorNode.parentElement;t instanceof HTMLElement&&(n=t.closest("[data-node-id]"))}n?.hasAttribute("data-whisper-block-focus")||(this.clearBlockFocusAttribute(t),n&&!n.closest(".protyle-wysiwyg__embed")&&(n.dataset.whisperBlockFocus=""))}}init(){document.addEventListener("mouseup",this.focusBlock,!0),document.addEventListener("keyup",this.focusBlock,!0),document.addEventListener("dragend",this.focusBlock,!0),document.addEventListener("touchend",this.focusBlock,!0),document.addEventListener("touchcancel",this.focusBlock,!0)}destroy(){document.removeEventListener("mouseup",this.focusBlock,!0),document.removeEventListener("keyup",this.focusBlock,!0),document.removeEventListener("dragend",this.focusBlock,!0),document.removeEventListener("touchend",this.focusBlock,!0),document.removeEventListener("touchcancel",this.focusBlock,!0),this.clearBlockFocusAttribute()}clearBlockFocusAttribute(e=document){e.querySelectorAll("[data-whisper-block-focus]").forEach(e=>{e instanceof HTMLElement&&delete e.dataset.whisperBlockFocus})}}const n=new class Logger{constructor(e){this.prefix="Whisper",e&&(this.prefix=e)}log(...e){console.log(`[${this.prefix}]`,...e)}error(...e){console.error(`[${this.prefix}]`,...e)}warn(...e){console.warn(`[${this.prefix}]`,...e)}info(...e){console.info(`[${this.prefix}]`,...e)}debug(...e){console.debug(`[${this.prefix}]`,...e)}};class ElementStatusObserver{constructor(){this.retryIntervalId=null,this.elementObserver=null,this.targets=[]}init(){this.setupTargets(),this.startObserving()}destroy(){this.retryIntervalId&&(clearInterval(this.retryIntervalId),this.retryIntervalId=null),this.elementObserver&&(this.elementObserver.disconnect(),this.elementObserver=null),setTimeout(()=>{"Whisper"!==getCurrentTheme()&&this.targets.forEach(e=>{e.found&&e.checks.forEach(e=>{const t=`data-${e.datasetProp.replace(/([A-Z])/g,"-$1").toLowerCase()}`;document.documentElement.removeAttribute(t)})})},3e3)}createBaseTarget(e,t,n){return{selector:e,checks:t,found:!1,timedOut:!1,element:null,exclude:n}}setupTargets(){this.targets=[this.createBaseTarget("#status",[{datasetProp:"whisperStatus",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}]),this.createBaseTarget("#dockLeft",[{datasetProp:"whisperDockLeft",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget("#dockRight",[{datasetProp:"whisperDockRight",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget("#dockBottom",[{datasetProp:"whisperDockBottom",attributeFilter:"class",check:e=>e.classList.contains("fn__none"),stateMap:{true:"hide",false:"show"}}],{selector:"body.body--window"}),this.createBaseTarget(".layout__dockl",[{datasetProp:"whisperLayoutDockl",attributeFilter:"style",check:e=>"0px"===e.style.width,stateMap:{true:"hide",false:"show"}},{datasetProp:"whisperLayoutDocklFloat",attributeFilter:"class",check:e=>e.classList.contains("layout--float"),stateMap:{true:"float",false:"pin"}}],{selector:"body.body--window"}),this.createBaseTarget(".layout__dockr",[{datasetProp:"whisperLayoutDockr",attributeFilter:"style",check:e=>"0px"===e.style.width,stateMap:{true:"hide",false:"show"}},{datasetProp:"whisperLayoutDockrFloat",attributeFilter:"class",check:e=>e.classList.contains("layout--float"),stateMap:{true:"float",false:"pin"}}],{selector:"body.body--window"})]}startObserving(){this.elementObserver=new MutationObserver(e=>{for(const t of e){const e=t.target,n=this.targets.find(t=>t.element===e);n&&n.checks.forEach(n=>{if(n.attributeFilter===t.attributeName){const t=n.check(e);document.documentElement.dataset[n.datasetProp]=n.stateMap[String(t)]}})}});let e=0;this.retryIntervalId=window.setInterval(()=>{e++;let t=!1;this.targets.forEach(s=>{if(s.found||s.timedOut)return;let i=!1;if(s.exclude){const e=document.querySelector(s.exclude.selector);e&&(i=!s.exclude.check||s.exclude.check(e))}if(i)return void(s.timedOut=!0);const o=document.querySelector(s.selector);o?(s.element=o,s.found=!0,this.setupObserver(s)):e>=50?(s.timedOut=!0,n.error(`failed to find target node: ${s.selector}`)):t=!0}),(!t||e>=50)&&this.retryIntervalId&&(clearInterval(this.retryIntervalId),this.retryIntervalId=null)},100)}setupObserver(e){if(!e.element||!this.elementObserver)return;e.checks.forEach(t=>{const n=t.check(e.element);document.documentElement.dataset[t.datasetProp]=t.stateMap[String(n)]});const t=Array.from(new Set(e.checks.map(e=>e.attributeFilter)));this.elementObserver.observe(e.element,{attributes:!0,attributeFilter:t})}}class TooltipHandler{constructor(){this.tooltipElement=null,this.updateTooltipData=async e=>{if(!e.target||9===e.target.nodeType)return;if(!this.tooltipElement)return void(await this.getTooltipElement());const t=3===e.target.nodeType?e.target.parentElement:e.target;if(t.closest('[data-type="navigation-file"]'))return void this.removeTooltipData();const n=t.getAttribute("data-href");if(n)return(e=>{if(!e)return!1;if(1>(e=e.trim()).length)return!1;if((e=e.toLowerCase()).startsWith("assets/")||e.startsWith("file://")||e.startsWith("\\\\"))return!0;if(isWindows())return 1===e.indexOf(":");return e.startsWith("/")})(n)?void this.setTooltipData("href_asset"):void this.setTooltipData("href",!0);t.closest('[data-type="tab-header"]')?this.setTooltipData("tab_header",!0):t.closest(".av__cell")||t.closest('[data-type="addColOptionOrCell"]')||t.closest('[data-type="av-add"]')||t.closest('[data-type="av-add-more"]')||t.closest('[data-type="av-header-add"]')||t.closest("[data-page]")||t.closest("[data-av-id]")?this.setTooltipData("av"):t.classList.contains("emojis__item")||t.classList.contains("emojis__type")?this.setTooltipData("emoji"):t.closest(".protyle-attr--memo")?this.setTooltipData("block_memo"):this.tooltipElement&&!this.tooltipElement.classList.contains("fn__none")&&(this.tooltipElement.dataset.whisperTooltip="")}}async getTooltipElement(){this.tooltipElement||(this.tooltipElement=document.getElementById("tooltip"))}async init(){await this.getTooltipElement(),this.tooltipElement||n.error("tooltip element does not exist."),document.addEventListener("mouseover",this.updateTooltipData)}async destroy(){document.removeEventListener("mouseover",this.updateTooltipData),await this.getTooltipElement(),this.tooltipElement?.removeAttribute("data-whisper-tooltip"),this.tooltipElement=null}setTooltipData(e,t=!1){if(this.tooltipElement)if(this.tooltipElement.dataset?.whisperTooltip!==e&&(this.tooltipElement.dataset.whisperTooltip=e),t){const e=this.tooltipElement.getAttribute("style")||"";this.tooltipElement.setAttribute("style",`${e} display: flex !important`)}else this.tooltipElement.style.removeProperty("display")}removeTooltipData(e){this.tooltipElement&&(e&&this.tooltipElement.dataset?.whisperTooltip!==e||(this.tooltipElement.dataset.whisperTooltip=""))}}function themeSwitch(s,i){switch(s){case"commonMenu":{const n=i.target.closest(".b3-menu__item")?.getAttribute("data-id");if(!n||!["themeLight","themeDark","themeOS"].includes(n))return;const s="themeOS"===n?window.matchMedia("(prefers-color-scheme: light)").matches?e:t:"themeLight"===n?e:t;if(s===getThemeCurrentMode()||"Whisper"!==getCurrentTheme(s))return;break}case"dialog":{const t=i.target,n=parseInt(t.closest("#mode")?.value);if(isNaN(n)||![0,1,2].includes(n))return;const s=2===n?getOSThemeModeValue():n;if(s===(()=>{const t=window.siyuan.config?.appearance?.mode;if(t)return t;const n=document.documentElement.getAttribute("data-theme-mode");return n?n===e?0:1:NaN})()||"Whisper"!==getCurrentThemeByValue(s))return;break}default:return}!function applyAnimation(e){if(!document.startViewTransition)return void n.error("View Transitions API is not supported");const t=document.startViewTransition(),s=e.clientX,i=e.clientY,o=Math.hypot(Math.max(s,window.innerWidth-s),Math.max(i,window.innerHeight-i)),r=document.createElement("style");r.innerHTML="::view-transition-old(root),::view-transition-new(root){animation: none;}",document.head.appendChild(r),t.ready.then(()=>{const e=document.documentElement.animate({clipPath:[`circle(0 at ${s}px ${i}px)`,`circle(${o}px at ${s}px ${i}px)`]},{duration:550,pseudoElement:"::view-transition-new(root)",easing:"ease-in-out"}),clickHandler=()=>{e.finish()};document.addEventListener("mousedown",clickHandler),e.onfinish=()=>{document.removeEventListener("mousedown",clickHandler),setTimeout(()=>{r?.remove()},300)}})}(i)}class MenuHandler{constructor(){this.commonMenuObserver=null,this.commonMenu=null,this.whisperCommonMenu=null,this.handleMenuClick=e=>{const t=e.target;"barmode"===(t.closest("#commonMenu")?.getAttribute("data-name")||"")&&themeSwitch("commonMenu",e)},this.handleCloseClick=e=>{e.target instanceof HTMLElement&&!e.target.closest(".b3-menu__submenu")&&(e.preventDefault(),e.stopPropagation())}}init(){this.setupMenuObserver()}destroy(){this.commonMenuObserver&&(this.commonMenuObserver.disconnect(),this.commonMenuObserver=null),this.commonMenu&&(this.commonMenu.removeEventListener("click",this.handleMenuClick,!0),this.commonMenu.removeEventListener("click",this.handleCloseClick,!0),this.commonMenu=null),this.whisperCommonMenu&&(this.whisperCommonMenu.remove(),this.whisperCommonMenu=null)}setupMenuObserver(){if(this.commonMenu=document.getElementById("commonMenu"),!this.commonMenu)return void n.error("commonMenu element does not exist.");const e=document.createElement("div");e.id="whisperCommonMenu",this.commonMenu.insertAdjacentElement("beforebegin",e),this.whisperCommonMenu=e,this.commonMenuObserver=new MutationObserver(()=>{if(this.whisperCommonMenu?.removeAttribute("data-name"),this.commonMenu){this.commonMenu.removeEventListener("click",this.handleMenuClick,!0),this.commonMenu.removeEventListener("click",this.handleCloseClick,!0);const e=this.commonMenu.getAttribute("data-name");"barmode"===e?this.commonMenu.addEventListener("click",this.handleMenuClick,!0):("tab"===e||this.commonMenu.querySelector('[data-id="close"]')&&this.commonMenu.querySelector('[data-id="split"]')&&this.commonMenu.querySelector('[data-id="copy"]'))&&(this.whisperCommonMenu&&(this.whisperCommonMenu.dataset.name="tab-header"),this.handleTabClose())}}),this.commonMenuObserver.observe(this.commonMenu,{attributes:!0})}handleTabClose(){if(!this.commonMenu)return;const e=this.commonMenu.querySelector('[data-id="close"]');if(!e)return;isTouchDevice()&&this.commonMenu.addEventListener("click",this.handleCloseClick,!0);const t=e.cloneNode(!0);t.querySelector(".b3-menu__icon")?.remove(),e.querySelector(".b3-menu__accelerator")?.remove(),e.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg><div class="b3-menu__submenu"><div class="b3-menu__items"></div></div>');const n=e.querySelector(".b3-menu__items");if(!n)return;n.appendChild(t),this.commonMenu.querySelectorAll('[data-id="closeOthers"], [data-id="closeAll"], [data-id="closeUnmodified"], [data-id="closeLeft"], [data-id="closeRight"]').forEach(e=>{e.querySelector(".b3-menu__icon")?.remove(),n.appendChild(e)});const s=this.commonMenu.querySelector('[data-id="split"] > .b3-menu__icon > use');s&&s.setAttribute("xlink:href","#iconSplitLR")}}class DialogHandler{constructor(){this.bodyObserver=null,this.searchAssetsObserver=null,this.searchTipElements=[],this.settingDialogObserver=null,this.modeSelect=null,this.handleModeChange=e=>{const t=e.target;if(t&&"mode"===t.id){const e=t.getBoundingClientRect(),n=e.left+e.width/2,s=e.top+e.height/2+30,i=new MouseEvent("click",{clientX:n,clientY:s,bubbles:!0,cancelable:!0});Object.defineProperty(i,"target",{value:t,enumerable:!0}),themeSwitch("dialog",i)}}}init(){document.querySelectorAll(".b3-dialog--open").forEach(e=>{this.handleDialogOpen(e)}),this.setupBodyObserver()}destroy(){this.bodyObserver?.disconnect(),this.bodyObserver=null,this.settingDialogObserver?.disconnect(),this.settingDialogObserver=null,this.modeSelect?.removeEventListener("change",this.handleModeChange),this.modeSelect=null,this.searchAssetsObserver?.disconnect(),this.searchAssetsObserver=null,this.searchTipElements.forEach(e=>{e.classList.remove("resize__move")}),this.searchTipElements=[]}setupBodyObserver(){this.bodyObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&setTimeout(()=>{const t=e;t.hasAttribute("data-key")&&this.handleDialogOpen(t)})})})}),this.bodyObserver.observe(document.body,{childList:!0})}handleDialogOpen(e){switch(e.dataset.key){case"dialog-setting":this.setupThemeChangeListener(e);break;case"dialog-globalsearch":case"dialog-search":this.handleSearchDialog(e);break;default:return}}setupThemeChangeListener(e){const t=e.querySelector("#mode");t?this.attachModeChangeListener(t):(this.settingDialogObserver=new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes){if(e.nodeType!==Node.ELEMENT_NODE)continue;const t=e;if("mode"===t.id)return this.settingDialogObserver?.disconnect(),void this.attachModeChangeListener(t);const n=t.querySelector("#mode");if(n)return this.settingDialogObserver?.disconnect(),void this.attachModeChangeListener(n)}}),this.settingDialogObserver.observe(e,{childList:!0,subtree:!0}))}attachModeChangeListener(e){this.modeSelect?.removeEventListener("change",this.handleModeChange),this.modeSelect=e,this.modeSelect.addEventListener("change",this.handleModeChange)}handleSearchDialog(e){this.searchTipElements=[],this.addResizeMoveToSearchDialog(e);const t=document.getElementById("searchAssets");t&&(t.children.length>0?this.addResizeMoveToSearchDialog(t):(this.searchAssetsObserver=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("search__tip")&&(this.searchAssetsObserver?.disconnect(),this.searchAssetsObserver=null,this.addResizeMoveToSearchDialog(t))})})}),this.searchAssetsObserver.observe(t,{childList:!0})))}addResizeMoveToSearchDialog(e){e.querySelectorAll(".search__tip, .fn__flex-column > .block__icons").forEach(e=>{e.classList.add("resize__move"),this.searchTipElements.push(e)})}}class MobileFunctionality{constructor(){this.observer=null}init(){this.addMobileAIConfig()}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),document.getElementById("menuAI")?.remove();document.querySelectorAll(".b3-menu__separator[data-whisper-separator]").forEach(e=>{e.remove()})}addMobileAIConfig(){const e=document.getElementById("menu");e?(this.observer=new MutationObserver((e,t)=>{const n=document.getElementById("menuRiffCard");if(n){t?.disconnect();if(!document.getElementById("menuAI")){const e=`<div class="b3-menu__item${window.siyuan.config?.readonly?" fn__none":""}" id="menuAI">\n                        <svg class="b3-menu__icon"><use xlink:href="#iconSparkles"></use></svg><span class="b3-menu__label">AI</span>\n                    </div>`;n.insertAdjacentHTML("afterend",e)}}}),this.observer.observe(e,{childList:!0,subtree:!0}),setTimeout(()=>{this.observer?.disconnect(),this.observer=null;document.getElementById("menuRiffCard")||n.error("menuRiffCard element does not exist.")},6e4)):n.error("mobileMenu element does not exist.")}}class EventBusManager{constructor(){this.themeName="whisper-theme",this.eventHandlers=new Map,this.eventBusHandler=e=>{switch(e.type){case"loaded-protyle-static":{const t=e.detail.protyle?.wysiwyg?.element;if("NodeListItem"===t?.dataset.docType){const e=t.querySelector(":scope > [data-node-id].li");e instanceof HTMLElement&&e.removeAttribute("fold")}break}}}}init(){["loaded-protyle-static"].forEach(e=>{this.eventBusOn(e,this.eventBusHandler)})}destroy(){this.eventHandlers.forEach((e,t)=>{this.eventBusOff(t,e)}),this.removeMyTheme()}getThisTheme(e=this.themeName){const t=window.siyuan.ws?.app?.plugins?.find(t=>t.name===e);if(t)return t;const n=document.createComment(e);document.appendChild(n);const s={name:e,app:window.siyuan.ws?.app?.appId||"",displayName:e,i18n:null,eventBus:{on:(e,t)=>{n.addEventListener(e,t)},once:(e,t)=>{n.addEventListener(e,t,{once:!0})},off:(e,t)=>{n.removeEventListener(e,t)},emit:(e,t)=>n.dispatchEvent(new CustomEvent(e,{detail:t,cancelable:!0}))},protyleSlash:[],topBarIcons:[],statusBarIcons:[],commands:[],models:{},docks:{},data:{},onload:()=>{},onunload:()=>{},uninstall:()=>{},updateCards:e=>e,onLayoutReady:()=>{},updateProtyleToolbar:e=>e};return window.siyuan.ws?.app?.plugins&&window.siyuan.ws.app.plugins.push(s),s}removeMyTheme(e=this.themeName){if(window.siyuan.ws?.app?.plugins){const t=window.siyuan.ws.app.plugins.findIndex(t=>t.name===e);t>-1&&window.siyuan.ws.app.plugins.splice(t,1)}this.cleanupCommentNode(e)}cleanupCommentNode(e){const t=document.evaluate(`//comment()[.='${e}']`,document,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let n=0;n<t.snapshotLength;n++){const e=t.snapshotItem(n);e&&e.parentNode&&e.parentNode.removeChild(e)}}eventBusOn(e,t){const n=this.getThisTheme();this.eventHandlers.set(e,t),n.eventBus.on(e,t)}eventBusOff(e,t){this.getThisTheme().eventBus.off(e,t),this.eventHandlers.delete(e)}}const checkConnectivity=async()=>{try{return 0===(await(async()=>{try{const e=await fetch("/api/system/currentTime",{method:"POST"});return await e.json()}catch(e){return{code:500,msg:`Request exception:${e instanceof Error?e.message:String(e)}`,data:null}}})()).code}catch{return!1}};let s=null;const checkConnectivityWithCache=async()=>{const e=Date.now();if(s&&s.isConnected&&e-s.lastCheckTime<6e5)return!0;const t=await checkConnectivity();return s=t?{isConnected:!0,lastCheckTime:e}:null,t},getFile=async(e,t={})=>{const{retryOnConnectivityError:n=!1,retryInterval:s=3e4,maxRetries:i=50}=t;let o=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(n&&o<i){o++,await new Promise(e=>setTimeout(e,s));continue}return{code:503,msg:"Server connectivity check failed",data:null}}const t=await fetch("/api/file/getFile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})});return 200===t.status?await t.text():202===t.status?await t.json():{code:t.status,msg:`Unknown error, status code:${t.status}`,data:null}}catch(r){return{code:500,msg:`Request exception:${r instanceof Error?r.message:String(r)}`,data:null}}},i=class _FileOperationQueue{static enqueue(e,t){const s=(this.queues.get(e)||Promise.resolve()).then(t,t);return this.queues.set(e,s),s.catch(t=>{throw n.error(`Operation error for ${e}:`,t),t})}};i.queues=new Map;let o=i;class LocalConfig{constructor(e,t){this.configPath="/conf/whisper-theme-config.json",this.defaultConfig={version:1},isPublish()||(e&&(this.configPath=e),t&&(this.defaultConfig=t))}async init(){try{const e={retryOnConnectivityError:!0,retryInterval:5e3,maxRetries:100},t=await this.readConfig(e);0===Object.keys(t).length?await this.resetConfig(e):1!==t.version&&(t.version=1,await this.writeConfig(t,e))}catch{await this.resetConfig({retryOnConnectivityError:!0,retryInterval:5e3,maxRetries:10})}}async readConfig(e){return o.enqueue(this.configPath,async()=>{try{const t=await getFile(this.configPath,e||{});if("string"!=typeof t||""===t.trim())return{};return JSON.parse(t)||{}}catch(t){return n.error(`Failed to read configuration: ${t instanceof Error?t.message:String(t)}`),{}}})}async writeConfig(e,t){return isPublish()?(n.error("Writing configuration is not supported in publish service"),!1):o.enqueue(this.configPath,async()=>{try{const s=await(async(e,t={})=>{const{retryOnConnectivityError:n=!1,retryInterval:s=3e4,maxRetries:i=50}=t;let o=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(n&&o<i){o++,await new Promise(e=>setTimeout(e,s));continue}return{code:503,msg:"Server connectivity check failed",data:null}}if(window.siyuan.isPublish)return{code:403,msg:"You are not allowed to write files in published workspace",data:null};const r=new FormData;r.append("path",e),void 0!==t.isDir&&r.append("isDir",t.isDir.toString()),void 0!==t.modTime&&r.append("modTime",t.modTime.toString()),t.file&&!t.isDir&&r.append("file",t.file);const a=await fetch("/api/file/putFile",{method:"POST",body:r});return await a.json()}catch(r){return{code:500,msg:`Request exception:${r instanceof Error?r.message:String(r)}`,data:null}}})(this.configPath,{isDir:!1,modTime:Math.floor(Date.now()/1e3),file:new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),...t});return 0===s.code||(n.error(`Failed to save configuration: ${s.msg}`),!1)}catch(s){return n.error(`Save configuration exception: ${s instanceof Error?s.message:String(s)}`),!1}})}async get(e,t,s){try{const n=await this.readConfig(s),i=e.split(".").reduce((e,t)=>e&&"object"==typeof e?e[t]:void 0,n);return void 0!==i?i:t}catch(i){return n.error(`Error getting config value at path '${e}': ${i instanceof Error?i.message:String(i)}`),t}}async set(e,t,s){try{const n=await this.readConfig(s),i=e.split(".");let o=n;for(let e=0;e<i.length-1;e++){const t=i[e];o[t]&&"object"==typeof o[t]&&!Array.isArray(o[t])||(o[t]={}),o=o[t]}return o[i[i.length-1]]=t,await this.writeConfig(n,s)}catch(i){return n.error(`Error setting config value at path '${e}': ${i instanceof Error?i.message:String(i)}`),!1}}async batchUpdate(e,t){try{const n=await this.readConfig(t);for(const[t,s]of Object.entries(e)){const e=t.split(".");let i=n;for(let t=0;t<e.length-1;t++){const n=e[t];i[n]&&"object"==typeof i[n]&&!Array.isArray(i[n])||(i[n]={}),i=i[n]}i[e[e.length-1]]=s}return await this.writeConfig(n,t)}catch(s){return n.error(`Error during batch update: ${s instanceof Error?s.message:String(s)}`),!1}}async resetConfig(e){return n.info("Reset configuration to default values"),await this.writeConfig({...this.defaultConfig},e)}async getAll(e){return await this.readConfig(e)}async remove(e,t){try{const n=await this.readConfig(t),s=e.split(".");let i=n;const o=s.length-1;for(let e=0;e<o;e++){const t=s[e];if(void 0===i[t]||null===i[t]||"object"!=typeof i[t])return!0;i=i[t]}const r=s[o];return void 0===i[r]||(delete i[r],await this.writeConfig(n,t))}catch(s){return n.error(`Error removing config value at path '${e}': ${s instanceof Error?s.message:String(s)}`),!1}}async deleteConfigFile(e){return isPublish()?(n.error("Deleting configuration file is not supported in publish service"),!1):o.enqueue(this.configPath,async()=>{try{const t=await(async(e,t={})=>{const{retryOnConnectivityError:n=!1,retryInterval:s=3e4,maxRetries:i=50}=t;let o=0;for(;;)try{if(!(await checkConnectivityWithCache())){if(n&&o<i){o++,await new Promise(e=>setTimeout(e,s));continue}return{code:503,msg:"Server connectivity check failed",data:null}}if(window.siyuan.isPublish)return{code:403,msg:"You are not allowed to delete files in published workspace",data:null};const t=await fetch("/api/file/removeFile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:e})});return await t.json()}catch(r){return{code:500,msg:`Request exception:${r instanceof Error?r.message:String(r)}`,data:null}}})(this.configPath,e||{});return 0===t.code?(n.info(`Configuration file deleted successfully: ${this.configPath}`),!0):(n.error(`Failed to delete configuration file: ${t.msg}`),!1)}catch(t){return n.error(`Delete configuration file exception: ${t instanceof Error?t.message:String(t)}`),!1}})}}const r="theme.googleAnalytics.lastSentTimestamp";class GoogleAnalytics{constructor(){this.scriptId="whisper-theme-analytics",this.gaId="G-ZY75BR723S",this.themeVersion=window.siyuan.config?.appearance?.themeVer,this.lastSentTimestamp=0,this.dateISO="",this.checkIntervalId=null}async fetchThemeVersion(){try{const e=await getFile("/conf/appearance/themes/Whisper/theme.json");if("string"==typeof e){const t=JSON.parse(e);return void(this.themeVersion=t.version)}}catch{n.error("Failed to get theme version")}this.themeVersion="unknown-version"}async init(){await new Promise(e=>setTimeout(e,5e3)),window.siyuan.config?.system?.disableGoogleAnalytics||window.siyuan.whisper.theme.googleAnalytics.disableGoogleAnalytics||(await this.checkAndSend(),this.checkIntervalId=window.setInterval(()=>{this.checkAndSend().catch(e=>{n.error("Failed to check and send analytics data:",e)})},6e4))}destroy(){null!==this.checkIntervalId&&(window.clearInterval(this.checkIntervalId),this.checkIntervalId=null);const e=document.getElementById(this.scriptId);e&&e.remove(),window.whisper_theme_gtag&&(window.whisper_theme_gtag=void 0)}async checkAndSend(){const e=Date.now();this.dateISO=(new Date).toISOString().split("T")[0];const t=new LocalConfig;await t.init();const n=await t.get(r,0,{retryOnConnectivityError:!0,retryInterval:2e4,maxRetries:60});void 0!==n&&e-n<18e5||(this.lastSentTimestamp=e,await t.set(r,this.lastSentTimestamp),this.initGA())}initGA(){if(!document.getElementById(this.scriptId)){const e=document.createElement("script");e.id=this.scriptId,e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id="+this.gaId,document.head.appendChild(e)}if(!window.whisper_theme_gtag){let gtag=function(...e){window.dataLayer=window.dataLayer||[],window.dataLayer.push(arguments)};window.whisper_theme_gtag=gtag,gtag("js",new Date),gtag("config",this.gaId,{send_page_view:!1,user_id:window.siyuan.user?.userId})}n.log("Sending Google Analytics data. https://github.com/TCOTC/Whisper/issues/11"),this.sendInfo()}async sendInfo(){this.themeVersion||await this.fetchThemeVersion();const e={theme_version:this.themeVersion,date_iso:this.dateISO,timestamp:this.lastSentTimestamp,language:navigator.language};try{const t=window.siyuan;t&&(t.config?.lang&&(e.app_language=t.config.lang),t.config?.system&&(e.app_version=t.config.system.kernelVersion,e.app_container=t.config.system.container,e.app_os=t.config.system.os,e.app_platform=t.config.system.osPlatform),t.config?.sync&&(e.sync_enabled=t.config.sync.enabled),t.config?.stat&&(e.user_create_time=t.user?.userCreateTime?.slice(0,6),e.tree_count=t.config.stat.cTreeCount,e.block_count=t.config.stat.cBlockCount))}catch(t){n.error("Error collecting SiYuan data for analytics:",t)}window.whisper_theme_gtag&&window.whisper_theme_gtag("event","theme_init",e)}trackEvent(e,t={}){window.whisper_theme_gtag&&(t.theme_version=this.themeVersion,window.whisper_theme_gtag("event",e,t))}trackFeatureUse(e,t={}){this.trackEvent("feature_use",{feature_name:e,...t})}}const showMessage=(e,t=6e3,n="info",s)=>{let i=document.getElementById("message");if(!i)return;if(i=i.firstElementChild,!i)return void document.body.insertAdjacentHTML("beforeend",`<div style="top: 10px;\n    position: fixed;\n    z-index: 100;\n    background: white;\n    padding: 10px;\n    border-radius: 5px;\n    right: 10px;\n    border: 1px solid #e0e0e0;" id='tempMessage'>${e}</div>`);const o=([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(parseInt(e,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(e,10)/4).toString(16)),r=i.querySelector(`.b3-snackbar[data-id="${o}"]`),a=e+("error"===n?" v"+(window.siyuan.config?.system?.kernelVersion??""):"");if(r){const e=r.getAttribute("data-timeoutid");if(e&&window.clearTimeout(parseInt(e)),r.innerHTML=`<div data-type="textMenu" class="b3-snackbar__content${0===t?" b3-snackbar__content--close":""}">${a}</div>${0===t?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,"error"===n?r.classList.add("b3-snackbar--error"):r.classList.remove("b3-snackbar--error"),t>0){const e=window.setTimeout(()=>{hideMessage(o)},t);r.setAttribute("data-timeoutid",e.toString())}return}let c=`<div data-id="${o}" class="b3-snackbar--hide b3-snackbar${"error"===n?" b3-snackbar--error":""}"><div data-type="textMenu" class="b3-snackbar__content${0===t?" b3-snackbar__content--close":""}">${a}</div>`;if(0===t)c+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(-1!==t){const e=window.setTimeout(()=>{hideMessage(o)},t);c=c.replace("<div data-id",`<div data-timeoutid="${e}" data-id`)}i.parentElement&&(i.parentElement.classList.add("b3-snackbars--show"),i.parentElement.style.zIndex=((window.siyuan.zIndex??0)+1).toString()),i.insertAdjacentHTML("afterbegin",c+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(e=>{e.classList.remove("b3-snackbar--hide")})});const l=i.firstElementChild;return l&&l.nextElementSibling&&l.nextElementSibling.innerHTML===l.innerHTML&&l.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),o},hideMessage=e=>{let t=document.getElementById("message");if(t&&(t=t.firstElementChild,t))if(e){const n=t.querySelector(`[data-id="${e}"]`);if(n){n.classList.add("b3-snackbar--hide");const e=n.getAttribute("data-timeoutid");e&&window.clearTimeout(parseInt(e)),setTimeout(()=>{n.remove(),0===t.childElementCount&&t.parentElement&&(t.parentElement.classList.remove("b3-snackbars--show"),t.innerHTML="")},256)}let s=!1;Array.from(t.children).find(e=>{if(!e.classList.contains("b3-snackbar--hide"))return s=!0,!0}),s&&t.parentElement?t.parentElement.classList.add("b3-snackbars--show"):t.parentElement&&t.parentElement.classList.remove("b3-snackbars--show")}else t.parentElement&&(t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.innerHTML=""},256))};class ModuleManager{constructor(){this.modules=[]}register(e){this.modules.push(e)}initAll(){this.modules.forEach(e=>{"function"==typeof e.init&&e.init()})}async destroyAll(){for(let e=this.modules.length-1;e>=0;e--){const t=this.modules[e];if("function"==typeof t.destroy){const e=t.destroy();e instanceof Promise&&await e}}this.modules=[]}}(()=>{function debug(){isMobile()&&message("isMobile"),navigator.userAgent.indexOf("iPad")>-1&&message("isIPad"),isTouchDevice()&&message("isTouchDevice")}function message(e){showMessage(e,1e4,"info")}!function initGlobalVariables(){window.siyuan.whisper??={},window.siyuan.whisper.debug??={},window.siyuan.whisper.theme??={},window.siyuan.whisper.theme.googleAnalytics??={},window.siyuan.whisper.loaded=!0}(),setTimeout(()=>{window.siyuan.whisper.debug?.showMessage&&debug()},5e3),n.log("Loaded");const e=new ModuleManager;e.register(new DeviceDetector),e.register(new BlockFocusHandler),e.register(new EventBusManager),isPublish()||e.register(new GoogleAnalytics),isMobile()?e.register(new MobileFunctionality):(e.register(new TooltipHandler),e.register(new ElementStatusObserver),e.register(new DialogHandler),e.register(new MenuHandler)),e.initAll(),window.destroyTheme=async()=>{await e.destroyAll(),window.siyuan.whisper.loaded=!1,n.log("Unloaded"),isPublish()||async function removeConfigFile(){if(await new Promise(e=>setTimeout(e,6e4)),window.siyuan.whisper.loaded)return;const e=window.siyuan.config?.appearance?.lightThemes,t=window.siyuan.config?.appearance?.darkThemes;if(!e||!t)return;let s=!0;if(e.forEach(e=>{"Whisper"===e.name&&(s=!1)}),t.forEach(e=>{"Whisper"===e.name&&(s=!1)}),s)try{const e=new LocalConfig;await e.deleteConfigFile({retryOnConnectivityError:!0,retryInterval:3e3,maxRetries:5})?n.log("Uninstall. Theme config file removed successfully"):n.error("Uninstall. Failed to remove theme config file")}catch(i){n.error(`Uninstall. Error removing theme config file: ${i instanceof Error?i.message:String(i)}`)}}()}})()}();
